<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">
  
<task type="function" name="simanalyze" category="simulation">
  <shortdescription>image and analyze MeasurementSets created with simobserve</shortdescription>
  <description>
    This task is for imaging and analyzing MeasurementSets simulated with
      simobserve or simalma.   
  </description>
  <example>
      * "project" needs to be the directory of results generated by running 
        simobserve or simalma. In particular $project/$project.skymodel 
        will be required in order to compare output and input images.

    -------------------------------
    mode image=True:
      * One should input one or more simulated MSs using the "vis" parameter.  
        These can include a total power MS. 
        Simanalyze will grid any total power MS, 
        clean (invert and deconvolve) any interferometric MSs, 
        and feather the results. 

      * the "vis" parameter:
        - example: single MS: vis="mysim.alma.out03.ms"
        - example: multiple MSs: vis="mysim.alma.out03.ms,mysim.aca.tp.ms"
        - one can use "$project" and let the task automatically replace it with
          the project name, e.g., vis="$project.noisy.ms,$project.noisy.sd.ms".
          However, note that if you created measurement set(s) using simobserve,
          MS names will include the configuration, e.g. 
          "$project.alma_out20.noisy.ms"
        - setting "vis" to "default" will find and attempt to image
          all measurement sets (interferometric and single dish) in the 
          project directory

      * Sometimes it is preferable to grid the single dish MS using the 
        sdimaging task for more control.  In that case one can input 
        the resulting single dish imaging under "featherimage", only 
        put interferometric MSs in "vis", and simanalyze  will clean the 
        interferometric and feather with your "featherimage".

      * Sometimes it is preferable to use a low resolution (single dish or 
        synthesis) image as a prior model during clean deconvolution
        of a higher resolution interferometric MS.  That is accomplished 
        by putting the low-resolution image in "modelimage" and the MS
        to be deconvolved in "vis". NOTE: This is not the original skymodel
        that was used in simobserve or simalma.  It is recommended to 
        leave this blank unless the user is familiar with using a prior 
        in clean deconvolution. (see casaguides) NOTE 2: modelimage will 
        not be used if the MS to be imaged is total power.
       
      * uses Cotton-Schwab clean for single fields and Mosaic gridding
        for multiple fields (with Clark PSF calculation in minor cycles).

      * interactive clean or use of more parameters than the subset 
        visible here are available by simply running the clean task directly, 
        then using simanalyze in the mode image=False (see below).

      * if graphics are turned on, this step will display the clean image 
        and residual image

      * the "mask" parameter:
        Specification of cleanbox(es), mask image(s), primary beam
        coverage level, and/or region(s) to be used for cleaning.
        clean tends to perform better, and is less likely to diverge, if 
        the clean component placement is limited by a mask to where real 
        emission is expected to be.  e.g. pixel ranges mask=[110,110,150,145],
        filename of mask image mask='myimage.mask', or a file with mask 
        regions --  see help for the clean task for more information.

      * NOTE: simanalyze was designed to be used after one or more runs of
        simobserve, and as such it assumes it will be able to find a 
        sky model image called $project/$project.skymodel, .newmodel, or 
        .compskymodel in the $project/ subdirectory.  If the simulated 
        MS has been created by means other than simply calling simobserve, 
        the user may have to copy their sky model image into the $project
        subdirectory and call it "$project.skymodel"

    -------------------------------
    mode image=False:
      * Sometimes the user has created a synthesized image themselves, 
        most likely using the clean task, perhaps along with 
        sdimaging and feather, or a previous call to simanalyze with image=True 
      * The user should input that simulated image as "imagename".  
        It will have suffix .image if created by clean, simanalyze, or simalma
      * simanalyze will attempt to find an appropriate skymodel image - 
        this is the *.skymodel image created by simobserve or simalma, 
        the (optionally rescaled) original sky model, which was used 
        to create the measurement set.
        simanalyze will look in the project directory, but if there are 
        multuple skymodels present it may not find the right one, so the
        "skymodel" parameter allows explicit specification.

    -------------------------------
    mode analyze=True is used to create an image of the difference between 
        the input skymodel and the simulated output image (whether that output
        image is being generated in the same call to simanalyze, with 
        image=True, or has already been generated, and simanalyze is being 
        called with image=False).

    showuv -- display uv coverage
    showpsf -- display synthesized (dirty) beam (ignored in single dish simulation)
    showmodel -- display sky model at original resolution
    showconvolved -- display sky model convolved with output beam 
    showclean -- display the synthesized image
    showresidual -- display the clean residual image (ignored in single dish simulation)
    showdifference -- display difference between output cleaned image and 
         input model sky image convolved with output clean beam
    showfidelity -- display fidelity image
         fidelity = abs(input) / max[ abs(input-output), 0.7*rms(output) ]
    

    Note that the RMS is calculated in the lower quarter of the image.  
         This is likely not the best choice, so you are encouraged to 
         measure RMS yourself in an off-source region using the viewer.

    dryrun=True is an advanced technical mode only useful for interferometric 
         (not single dish) data. 

    -------------------------------
    Output produced: (not all will always exist, depending on input parameters)
    To support different runs with different arrays, the names have the
    configuration name from antennalist appended.
    -------------------------------
    project.[cfg].skymodel.flat.regrid.conv = input sky regridded to match 
         the output image, and convolved with the output clean beam

    project.[cfg].image = synthesized image
    project.[cfg].flux.pbcoverage = primary beam correction for mosaic image
    project.[cfg].residual = residual image after cleaning
    project.[cfg].clean.last = parameter file of what parameters were used in
          the clean task
    project.[cfg].psf = synthesized (dirty) beam calculated from weighted uv 
          distribution
    project.[cfg].image.png = diagnostic figure of clean image and residual

    project.[cfg].fidelity = fidelity image
    project.[cfg].analysis.png = diagnostic figure of difference and fidelity

    project.[cfg].simanalyze.last = saved input parameters for simanalyze task

    -------------------------------
    Please see http://casaguides.nrao.edu, and contact the CASA helpdesk 
    with questions.
  </example>
  
  <input>
    
    <param type="string" name="project">
      <shortdescription>root prefix for output file names</shortdescription>
      <description>
        root prefix for input and output file names.  
        This must be the directory of results generated by running 
        simobserve or simalma. In particular $project/$project.skymodel 
        will be required in order to compare output and input images.
      </description>
      <value>sim</value>
    </param>
    


<!--  IMAGE   -->    

    <param type="bool" name="image">
      <shortdescription>(re)image $project.*.ms to $project.image</shortdescription>
      <description>Controls whether tclean is called to image the MeasurementSet data. If enabled, the simutil method imtclean is called with dryrun=False.</description>
      <value>True</value>
    </param>    

    <!-- if IMAGE==False -->
    
    <param type="string" name="imagename" subparam='true'>
      <shortdescription>simulation output image to analyze</shortdescription>
      <description>Name of image to image/analyze, expected to be of the same form as those generated by simobserve. Defaults to the first file found with the name $project/*.image</description>
      <value>default</value>
    </param>

    <param type="string" name="skymodel" subparam='true'>
      <shortdescription>skymodel image to analyze</shortdescription>
      <description>Name of the .skymodel image created by simobserve or simalma and used by one of those tasks to create a MS. If unspecified, will try to find one similar to your specified output image name.</description>
      <value/>
    </param>

    <!-- if IMAGE==True -->

    <param type="string" name="vis" subparam='true'>
      <shortdescription>Measurement Set(s) to image</shortdescription>
      <description>Name of the Measurement Set(s) to image, specified as a string or string containing a comma separating the names.</description>
      <value>default</value>
    </param>

    <param type="string" name="modelimage" subparam='true'>
      <shortdescription>image to use as clean prior</shortdescription>
      <description>Name of image to use as a prior for tclean, passed to the startmodel parameter via the simutil method imtclean. Commonly an existing, lower resolution total power image. Note that this is seaparate from the functionality controlled by the featherimage parameter.</description>
      <value type="string"></value>
    </param>
    
    <param type="intArray" name="imsize" subparam="true">
      <shortdescription>output image size in pixel units</shortdescription>
      <description>A list of integers corresponding to the number of pixels in (x,y) dimensions of output image. If 0, will attempt to match model image.</description>
      <value type="intArray"><value>0</value><value>0</value></value>
    </param>

    <param type="string" name="imdirection" subparam="true">
      <shortdescription>set output image direction</shortdescription>
      <description>A string corresponding to a direction to adopt as phase center, including epoch, right ascension, and declination. If unset, will adopt center on the model.</description>
      <value type="string"></value>
    </param>

    <param type="string" name="cell" subparam='true'>
      <shortdescription>cell size with units</shortdescription>
      <description>Specify the cell size with units, e.g., "10arcsec". If left unset (an empty string), the model cell size will be used. This is the default setting.</description>
      <value type="string"></value>
    </param>
    
    <param type="bool" name="interactive" subparam='true'>
      <shortdescription>call tclean in interactive mode</shortdescription>
      <description>Controls how the simutil method imtclean will call the tclean task. If this parameter is set to True, make sure to set the parameter niter to a value greater than zero.</description>
      <value type="bool">False</value>
    </param>


<!-- force the same channelization as the ms -->
<!--
    <param type="string" name="start" subparam="true">
      <description>frequency of first channel (default=ms)</description>
      <value>89GHz</value>
    </param>    
    <param type="string" name="width" subparam="true">
      <description>channel width (default=ms)</description>
      <value>10MHz</value>
    </param>
    <param type="int" name="nchan" subparam="true">
      <description>number of channels or -1 for full range</description>
      <value>-1</value>
    </param>
-->    
    <param type="int" name="niter" subparam="true">
      <shortdescription>maximum number of iterations</shortdescription>
      <description>Controls the value of the niter parameter in tclean call, and thus the maximum number of iterations per minor cycle. Set to 0 to produce a dirty image. Can also be modified through the viewer GUI via the interactive parameter.</description>
      <value>0</value>
    </param>

    <param type="string" name="threshold" subparam="true">
      <shortdescription>target flux level and units</shortdescription>
      <description>Set the quantity corresponding to the target flux level at which to stop cleaning. This value is passed to tclean via the simutil method imtclean.</description>
      <value>0.1mJy</value>
    </param>

    <param type="string" name="weighting" subparam="true">
      <shortdescription>control image weighting method</shortdescription>
      <description>Set the weighting scheme to apply to visibilities during image reconstruction. If set to briggs, will use the tclean default robust parameter (0.5)</description>
      <value>natural</value>
      <allowed kind="enum">
	<value>natural</value>
	<value>uniform</value>
	<value>briggs</value>  <!-- robust=0.5  -->
      </allowed>
    </param>

    <param type="any" name="mask" subparam="true">
      <shortdescription>Cleanbox(es), mask image(s), region(s), or a level</shortdescription>
      <description>Accepts a list of cleanbox(es), mask image(s), region(s), or a level. Input to this parameter will specify areas to be searched for clean components.</description>
      <any type="variant"/>
      <!-- <value type="stringArray"></value> -->
      <value type="intArray"></value>
    </param>

    <param type="stringArray" name="outertaper" subparam="true">
      <shortdescription>uv-taper on outer baselines in uv-plane</shortdescription>
      <description>Accepts a list of strings in the form of a quantity that sets an other threshold on baselines in the uv-plane. Usually used to achieve a lower effective angular resolution and recover more extended emission in reconstructed image. If left unset via empty list (the default) no outer taper will be applied.</description>
    <value/>
    </param>

    <param type="bool" name="pbcor" subparam="true">
      <shortdescription>correct synthesis images for primary beam response?</shortdescription>
      <description>Controls whether primary beam correction is applied in the call to task tclean.</description>
      <value type="bool">True</value>
    </param>

    <param type="string" name="stokes" subparam="true">
      <shortdescription>Stokes parameters to image</shortdescription>
      <description>Stokes parameters to include in the call to tclean via the simutil method imtclean. Note that forming Stokes Q and U images requires the presence of cross-hand polarizations (e.g., RL and LR for circularly polarized systems such as the VLA) in the input data. Stokes V requires both parallel hands (RR and LL) for circularly-polarized systems or the cross-hands (XY and YX) for linearly polarized systems such as ALMA and ATCA.</description>
      <value>I</value>
      <allowed kind="enum">
  <value>I</value>
  <value>IV</value>
  <value>QU</value>
  <value>IQUV</value>
  <value>RR</value>
  <value>LL</value>
  <value>RRLL</value>
  <value>XX</value>
      <value>YY</value>
      <value>XXYY</value>
      </allowed>
    </param>

    <param type="string" name="featherimage" subparam='true'>
      <shortdescription>image to feather with new image</shortdescription>
      <description>String corresponding to the name of an image (e.g., total power data) to feather with the interferometric synthesis image. Sometimes it is preferable to grid the single dish MS using the sdimaging task for more control. In that case, the user can input the resulting single dish imaging under featherimage, only pass interferometric data as input to the vis parameter, and this task will clean the interferometric and feather with the featherimage.</description>
      <value/>
    </param>







<!--  ANALYZE   -->    
    
    <param type="bool" name="analyze">
      <shortdescription>create analytical images</shortdescription>
      <description>Controls whether analytical images pertaining to the simulation will be created. If True, only the first 6 selected subparameter outputs will be displayed.</description>
      <value>False</value>
    </param>

<!--    
    <param type="string" name="sim_image" subparam="true">
      <description>simulated image, created by this task or manually</description>
      <value>$project/$project.image</value>
    </param>
-->

    <param type="bool" name="showuv" subparam="true">
      <shortdescription>display uv coverage</shortdescription>
      <description>Displays a plot of the simulated uv coverage</description>
      <value>True</value>
    </param>

    <param type="bool" name="showpsf" subparam="true">
      <shortdescription>display synthesized beam</shortdescription>
      <description>Displays synthesized (dirty) beam. Ignored in single dish simulation.</description>
      <value>True</value>
    </param>

    <param type="bool" name="showmodel" subparam="true">
      <shortdescription>display sky model at original resolution</shortdescription>
      <description>Displays the sky model at original resolution of input image.</description>
      <value>True</value>
    </param>
    
    <param type="bool" name="showconvolved" subparam="true">
      <shortdescription>display sky model convolved with output clean beam</shortdescription>
      <description>Displays the sky model convolved with output clean beam.</description>
      <value>False</value>
    </param>
    
    <param type="bool" name="showclean" subparam="true">
      <shortdescription>display the synthesized image</shortdescription>
      <description>Displays the synthesized image produced by the call to task tclean.</description>
      <value>True</value>
    </param>

    <param type="bool" name="showresidual" subparam="true">
      <shortdescription>display the clean residual image</shortdescription>
      <description>Displays the residual image produced by the call to task tclean. Ignored in single dish simulations.</description>
      <value>False</value>
    </param>

    <param type="bool" name="showdifference" subparam="true">
      <shortdescription>display difference between cleaned output and convovled model input</shortdescription>
      <description>Displays a difference image between cleaned image output by the tclean call, and input model sky image convolved with synthesized beam determined by output of tclean call.</description>
      <value>True</value>
    </param>
    
    <param type="bool" name="showfidelity" subparam="true">
      <shortdescription>display fidelity image</shortdescription>
      <description>Display a fidelity image, defined as the input normalized by the larger of the two: input - output OR 70 percent of the RMS of the output.</description>
      <value>True</value>
    </param>





    <param type="string" name="graphics">
      <shortdescription>where to display graphics at each stage</shortdescription>
      <description>Controls where graphics are displayed. Options are screen, file, both, or none.</description>
      <value type="string">both</value>
      <allowed kind="enum">
	<value>screen</value>
	<value>file</value>
	<value>both</value>
	<value>none</value>
	<value></value>
      </allowed>
    </param>

    <param type="bool" name="verbose">
      <shortdescription>report task activity</shortdescription>
      <description>Controls task activity is reported in the log.</description>
      <value>False</value>
    </param>

    <param type="bool" name="overwrite">
      <shortdescription>overwrite files starting with $project</shortdescription>
      <description>Controls whether the task will overwrite existing files starting with $project name.</description>
      <value>True</value>
    </param>

    <param type="bool" name="dryrun" visibility="hidden">
      <shortdescription>only print information</shortdescription>
      <description>Experimental feature for interfermetric data only. Controls whether information pertaining to the tclean call and analysis will be recorded and written to files for inspection and adaption.</description>
      <value>False</value>
    </param>

    <param type="string" name="logfile">
      <shortdescription>user-defined log file</shortdescription>
      <description>Allows for a user-defined log file naming convention if the verbose parameter is set to True.</description>
      <value/>
    </param>



        
    
<!--  CONSTRAINTS  -->    
    
    <constraints>
      <when param="image">
  <equals type="bool" value="True">
    <default param="vis"><value type="string">default</value></default>
    <default param="modelimage"><value type="string"></value></default>
    <default param="imsize">
      <value>0</value>
    </default>
    <default param="imdirection">
      <value type="string"></value>
    </default>
    <default param="cell"><value type="string"></value></default>
    <default param="interactive"><value>False</value></default>
    <default param="niter"><value>0</value></default>
    <default param="threshold"><value type="string">0.1mJy</value></default>
    <default param="weighting"><value type="string">natural</value></default>
    <default param="mask">      <value type="intArray"></value></default>
    <default param="outertaper"><value type="stringArray"></value></default>
    <default param="pbcor"><value type="bool">True</value></default>
    <default param="stokes"><value type="string">I</value></default>
    <default param="featherimage"><value type="string"></value></default>

  </equals>
  <equals type="bool" value="False">
    <default param="imagename"><value type="string">default</value></default>
    <default param="skymodel"><value type="string"></value></default>
  </equals>
      </when>
      <!-- **********************************************************  -->
      <when param="analyze">
  <equals type="bool" value="False"/>
  <equals type="bool" value="True">
<!--
    <default param="sim_image"><value>$project/$project.image</value></default>
-->
    <default param="showuv"><value type="bool">True</value></default>
    <default param="showpsf"><value type="bool">True</value></default>
    <default param="showmodel"><value type="bool">True</value></default> 
    <default param="showconvolved"><value type="bool">False</value></default>
    <default param="showclean"><value type="bool">True</value></default>
    <default param="showresidual"><value type="bool">False</value></default>
    <default param="showdifference"><value type="bool">True</value></default>
    <default param="showfidelity"><value type="bool">True</value></default>
  </equals>
      </when>
    </constraints>
    
    
    
  </input>
  <returns type="void"/>
  
</task>
</casaxml>
