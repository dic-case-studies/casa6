%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% STM 2007-04-13  split from previous version
% STM 2007-08-24  quick update
% DK  2007-10-10  beta release
% STM 2007-10-10  spell-check
% DK  2007-10-11  update
% DK  2007-10-12  update
% DK  2008-10-02  update patch3
% JO 2010-03-03 updates for 3.0.1
% JO 2011-10-08  Release 3.3.0 edits
% JO 2011-05-09  Release 3.4 edits and Harald Kuemmel edits. 
% AKL 2012-10-?? Release 4.0 edits
% JO 2012-10-24  Release 4.0 edits
% AKL 2013-05-26 Release 4.1 edits
% JO  2013-05-28 more edits
%  JO 2013-12-15 Release 4.2 edits

\chapter{Visualization With The CASA Viewer}
\label{chapter:display}

This chapter describes using the CASA Viewer to display data.
The Viewer can be started as a stand-alone executable or by the
{\tt viewer} task inside a CASA shell. It can display both images and Measurement Sets. 
We are in the process of splitting the task-level access to the Viewer into 
two tasks: {\tt imview} for images and {\tt msview} for measurement 
sets. These tasks offer improved scriptability, giving command
line access to many of the viewer features. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Starting the Viewer}
\label{section:display.start}

\begin{figure}[h!]
\begin{center}
\pngname{viewer-start-41}{5}
\caption{\label{fig:viewer_start} The {\bf Viewer Display Panel} (left) and 
the {\bf Data Display Options} (right) panel for a regular image or data cube.}
\hrulefill
\end{center}
\end{figure}

Within the casapy environment, the {\tt viewer} task
can be used to start the CASA Viewer, displaying an image or MS.  The inputs are:
\small
\begin{verbatim}
#  viewer :: View an image or visibility data set.

infile        =         ''   #   (Optional)  Name of file to visualize.
displaytype   =   'raster'   #   (Optional)  Type of visual rendering
                             #   (raster, contour, vector or marker).
                             #   lel  if an lel expression is given
                             #   for infile (advanced).

\end{verbatim}
\normalsize

Examples of starting the CASA Viewer:
\small
\begin{verbatim}
  CASA <1>: viewer()

  CASA <2>: viewer('ngc5921.demo.ms')

  CASA <3>: viewer('ngc5921.demo.cleanimg.image')

  CASA <4>: viewer('ngc5921.demo.cleanimg.image', 'contour')
  
  CASA <5>: viewer('"ngc5921.demo.cleanimg.image"^2', 'lel')
\end{verbatim}
\normalsize

The first command creates an empty {\bf Viewer Display Panel} 
(\S~\ref{section:display.viewerGUI.displaypanel}) and a {\bf Load Data} 
window (\S~\ref{section:display.dataManager.load}) .  The second starts the
CASA Viewer and loads a Measurement Set.  The third example
starts the Viewer and opens an image data cube (see Figure~\ref{fig:viewer_start}).  

Examples four and five make use of the second parameter ({\tt displaytype}).  Example 
four displays the image as a contour map rather than the default raster map.  Example 
five uses 'Lattice (Image) Expression Language' to display the square of the image data.

Note that the Viewer can open FITS files, CASA image files, Measurement Sets,
and saved viewer states. The Viewer determines the type of file being opened automatically.

For additional scripting options when opening the Viewer, see the discussion of the 
{\tt imview} and {\tt msview} tasks at the end of this Chapter (\S \ref{section:display.imview} and
\ref{section:display.msview}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Running the CASA Viewer outside {\tt casapy}}
\label{section:display.start.casaviewer}

If you have CASA installed, then the CASA Viewer is available as a
stand-alone application called {\tt casaviewer}.  From the operating system prompt,
the following commands work the same as the {\tt casapy} task commands
given in the previous Section:

\small
\begin{verbatim}
  casaviewer &
  
  casaviewer ms_filename &
  
  casaviewer image_filename &
  
  casaviewer image_filename contour &
  
  casaviewer '"image_filename"^2' lel &
\end{verbatim}
\normalsize



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Viewer Display Panel}
\label{section:display.viewerGUI.displaypanel}

The CASA Viewer consists of a number of graphical user interface (GUI) windows.
The main {\bf Viewer Display Panel} (\S~\ref{section:display.viewerGUI.displaypanel})
is used for both image and Measurement Set viewing. It is shown in the left panels of 
Figures~\ref{fig:viewer_start} and \ref{fig:viewer_start_ms} and appears the same whether 
an image or Measurement Set is being displayed.

\begin{figure}[h!]
\begin{center}
\pngname{viewer-start-ms}{5}
\pngname{viewer_n5921ms_1}{4.3}
\pngname{viewer_n5921ms_2}{2.1}
\caption{\label{fig:viewer_start_ms} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} (right) panels with a Measurement Set open.} 
\hrulefill
\end{center}
\end{figure}

% \begin{figure}[h!]
% \gname{viewer0}{4}
% \caption{\label{fig:viewer0} Viewer Display Panel with no data
%   loaded. Each section of the GUI is explained below} 
% \hrulefill
% \end{figure}

At the top of the Viewer Display Panel are drop down menus:

\begin{itemize}
\item {\bf Data}
  \begin{itemize}
      \item  {\tt Open} --- open the Data Manager window (\S \ref{section:display.dataManager}).
      \item  {\tt Register} --- select and de-select which of the loaded
             data file(s) should be displayed. The menu expands
	     to the right showing all loaded data sets. Unchecking an image
	     will cause it not to be displayed, but does not close it. 
      \item  {\tt Close} --- close (unload) the selected data file. The menu
             expands to the right showing all loaded data.
      \item  {\tt Adjust Data Display} --- open the Data Display Options ('Adjust') window (\S \ref{section:display.image.raster}).
      \item  {\tt Save as...} --- save/export data to a file
      \item  {\tt Print} --- print the displayed image
      \item  {\tt Save Panel State} --- to a 'restore' file (xml format)
      \item  {\tt Restore Panel State} --- from a restore file
      \item  {\tt Preferences} --- manually edit the viewer configuration
      \item  {\tt Close Panel} --- close this Viewer Display Panel. If this is the last display
      panel open, this will exit the Viewer.
      \item  {\tt Quit Viewer} --- close all display panels and exit
  \end{itemize}
\item {\bf Display Panel}
  \begin{itemize}
      \item {\tt New Panel} --- create a new, empty Viewer Display Panel
      \item {\tt Panel Options} --- open the Viewer Canvas Manager window to edit margins, the number of panels, and the background (\S \ref{section:display.viewerGUI.canvas.multi}).
      \item  {\tt Save Panel State} --- save the current state of the viewer as a file that can later be reloaded.
      \item  {\tt Restore Panel State} --- restore the viewer to a state previously saved as a file.
      \item {\tt Print} --- print displayed image
      \item {\tt Close Panel} --- close this Viewer Display Panel. If this is the last display
      panel open, this will exit the Viewer.
  \end{itemize}
\item {\bf Tools}
  \begin{itemize}
      \item {\tt Spectral Profile} --- Open the Spectral Profile Browser window to look at intensity as a function of frequency for part of an image (\S \ref{section:display.image.specprof.mainwindow})
       \item {\tt Collapse Image} --- Open the Collapse/Moments window, which allows you to create new images from a data cube by integrating along the spectral axis (\S \ref{section:display.image.collapse})
       \item {\tt Histogram} --- Open the Histogram inspection window, which allows you to graphically examine the distribution of pixel values in a data cube (\S \ref{section:display.image.histogram})
       \item {\tt Fit} --- Open the two-d fitting window, which can be used to fit Gaussians to two dimensional intensity distributions (\S \ref{section:display.image.twodfit}).
       \item {\tt Interactive Clean} --- Open a window to look at ongoing interactive clean processes.
  \end{itemize}
\item {\bf View}
  \begin{itemize}
      \item {\tt Main Toolbar} --- show/hide the top row of icons (Figure \ref{fig:viewer_maintoolbar}, \S \ref{section:display.viewerGUI.displaypanel.maintoolbar}).      
      \item {\tt Mouse Toolbar} --- show/hide the second row of mouse-button action selection icons (Figure \ref{fig:viewer_mousetoolbar}, \S \ref{section:display.viewerGUI.displaypanel.mousetoolbar}).
      \item {\tt Animator} --- show/hide tapedeck control panel attachment to the main Viewer Display Panel (\S \ref{section:display.viewerGUI.displaypanel.displayarea}).
      \item {\tt Position Tracking} --- show/hide the position tracking attachment to the main Viewer Display Panel (\S \ref{section:display.viewerGUI.displaypanel.displayarea}).
      \item {\tt Regions} --- show/hide the region manager attachment to the main Viewer Display Panel (\S \ref{section:display.viewerGUI.displaypanel.displayarea}).
  \end{itemize}
\end{itemize}

\subsection{The Main Toolbar}
\label{section:display.viewerGUI.displaypanel.maintoolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_maintoolbar_41}{5}
\caption{\label{fig:viewer_maintoolbar} The display panel's
{\bf Main Toolbar} appears directly below the menus and contains
'shortcut' buttons for most of the frequently-used menu items.}
\hrulefill
\end{center}
\end{figure}

Below the drop down menus is the {\bf Main Toolbar} (Figure~\ref{fig:viewer_maintoolbar}).
This top row of icons offers fast access to these menu items:
\begin{itemize}
   \item {\bf folder} ({\tt Data:Open} shortcut) --- open the Data Manager window (\S \ref{section:display.dataManager})
   \item {\bf wrench} ({\tt Data:Adjust} shortcut) --- open the Data Display Options ('Adjust') window (\S \ref{section:display.image.raster}).
   \item {\bf panels} ({\tt Data:Register} shortcut) --- select and de-select which of the loaded
             data file(s) should be displayed. The menu expands
	     to the right showing all loaded data sets. Unchecking an image
	     will cause it not to be displayed, but does not close it. 
   \item {\bf delete} ({\tt Data:Close} shortcut) --- close (unload) the selected data file. The menu
             expands to the right showing all loaded data.
   \item {\bf save data} ({\tt Data:Save as}) --- save the current data to a file.
   \item {\bf new panel} ({\tt Display Panel:New Panel}) --- create a new, empty Viewer Display Panel
   \item {\bf panel wrench} ({\tt Display Panel:Panel Options}) --- open the Viewer Canvas Manager window to edit margins, the number of panels, and the background (\S \ref{section:display.viewerGUI.canvas.multi}).
   
   \item  {\bf save panel} ({\tt Display Panel: Save Panel State}) --- save panel state to a 'restore' file
   \item  {\bf restore panel} ({\tt Display Panel: Restore Panel State}) --- restore panel state from a restore file
   \item  {\bf spectral profile} ({\tt Tools: Spectral Profile}) --- Open the Spectral Profile Browser window to look at intensity as a function of frequency for part of an image (\S \ref{section:display.image.specprof.mainwindow})
   \item  {\bf collapse/moments}({\tt Tools: Collapse Image}) --- Open the Collapse/Moments window, which allows you to create new images from a data cube by integrating along the spectral axis (\S \ref{section:display.image.collapse})
   \item  {\bf histogram}({\tt Tools:Histogram}) --- Open the Histogram inspection window, which allows you to graphically examine the distribution of pixel values in a data cube (\S \ref{section:display.image.histogram})
   \item  {\bf fitting}({\tt Tools:Fit}) -- Open the two-d fitting window, which can be used to fit Gaussians to two dimensional intensity distributions (\S \ref{section:display.image.twodfit}).
  % \item {\bf region save} ({\tt Tools:Region Manager}) --- save/control   
   \item {\bf print} ({\tt Display Panel:Print}) --- print the current display
   \item {\bf magnifier box} --- zoom out all the way
   \item {\bf magnifier plus} --- zoom in (by a factor of 2)
   \item {\bf magnifier minus} --- zoom out (by a factor of 2)
\end{itemize}

\subsection{The Mouse Toolbar}
\label{section:display.viewerGUI.displaypanel.mousetoolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_mousetoolbar_41}{5}
\caption{\label{fig:viewer_mousetoolbar} The 
{\bf 'Mouse Tool' Bar} allows you to assign how mouse buttons behave in 
the image display area.  Initially, zooming, color adjustment, and rectangular 
regions are assigned to the left, middle and right mouse buttons. Click on a tool
with a mouse button to assign that tool to that mouse button.}
\hrulefill
\end{center}
\end{figure}

Below the Main Toolbar are eleven {\bf Mouse Tool} buttons
(Figure~\ref{fig:viewer_mousetoolbar}). These allow you to assign
what behavior the three mouse buttons have when clicked in the display area. Clicking a mouse 
tool icon will [re-]assign the mouse button that was clicked to that tool. 
Black and white squares beneath the icons show which mouse button is currently
assigned to which tool.  

The mouse tools available from the toolbar are:

({\em Note that the 'escape' key can be used to cancel any mouse tool operation that was
begun but not completed, and to erase a region, point, or other tool showing in the display area.})

\begin{itemize}
   \item {\bf Zooming (magnifying glass icon):}
     To zoom into a selected area, press the Zoom tool's mouse button
     (the {\bf left} button by default) on one corner of the desired
     rectangle and drag to the desired opposite corner. Once the button is
     released, the zoom rectangle can still be moved or resized by dragging.
     To complete the zoom, double-click inside the selected rectangle. If you
     instead double-clicking {\it outside} the rectangle, you will zoom {\it out}.
   \item {\bf Panning (hand icon):} Press the tool's mouse button on a 
     point you wish to move, drag it to the position where you want it
     moved, and release. {\it Note: The arrow keys, Page Up, Page Down,
     Home and End keys can also be used to pan through your data any time
     you are zoomed in. (Click on the main display area first, to be sure
     the keyboard is 'focused' there).}
   \item {\bf Stretch-shift colormap fiddling (crossed arrows):} This is
     usually the handiest color adjustment; it is assigned to the {\bf middle}
     mouse button by default. Note that you can also adjust the color table
     quantitatively inside the Data Display Options window (\S \ref{section:display.image.raster}).
   \item {\bf Brightness-contrast colormap fiddling (light/dark sun)}: Another tool to adjust
   the color stretch.
   \item {\bf Positioning (plus):} This tool can place a point
     marker on the display to select a position. It is used to flag
     Measurement Set data or to select an image position for spectral
     profiles.  Click on the desired position with the tool's mouse
     button to place the point; once placed you can drag it to other
     locations. You can also place multiple points on the display
     (e.g. for different spectral profile positions) -- remove them by
     hovering over and hitting {\tt ESC}.  Double-click is not needed
     for this tool.  See
     \S~\ref{section:display.viewerGUI.displaypanel.region.pos} for more
     detail.
   \item {\bf Rectangle, Ellipse and Polygon region drawing:} The rectangle
     region tool is assigned to the {\bf right} mouse button by default.
     As with the zoom tool, a rectangle region is generated by dragging with
     the assigned mouse button; the selection is confirmed by double-clicking
     within the rectangle.
     An ellipse regions is created by dragging with the assigned mouse button.
     In addition to the elliptical region, also its surrounding rectangle is
     shown on the display. The selection is confirmed by double-clicking within
     the ellipse.
     Polygon regions are created by clicking the assigned mouse button
     at the desired vertices, clicking the final location twice to finish.
     Once created, a polygon can be moved by dragging from inside, or
     reshaped by dragging the handles at the vertices. 
     See \S~\ref{section:display.viewerGUI.displaypanel.region.pos} for the uses
     of this tool.
   \item {\bf Polyline drawing:}
     A polyline can be created by selecting this tool. It is manipulated
     similarly to the polygon region tool: create segments by clicking at
     the desired positions and then double-click to finish the line.
     [Uses for this tool are still to be implemented].
   \item {\bf Distance tool:}
     After selecting the distance tool by assigning any mouse button to it,
     distances on the image can conveniently be measured by dragging the
     mouse with the assigned button pressed. The tool measures the distances
     along the world coordinate axes and along the hypotenuse. If the units
     in both axes are $[deg]$, the distances are displayed in $[arcsec]$.
   \item {\bf Position-Velocity Diagram:} Use this mouse tool to drag out a position
   axis that can be used to generate a position velocity diagram in a new
   viewer panel from the region manager dock.
\end{itemize}

\subsection{The Display Area}
\label{section:display.viewerGUI.displaypanel.displayarea}

The main {\bf Display Area} lies below the toolbars. This area shows
the image or Measurement Set currently loaded. Clicking the mouse inside
the display area allows region or position selection according to the settings
in the mouse toolbar.

The Display Area may have up to three attached panels: the {\bf
  Animator} panel, the {\bf Position Tracking} panel, and the {\bf
  Regions} panel. These may be displayed or hidden from the "View"
  dropdown menu in the main Viewer Display Panel. If one of these is missing
  from your viewer, check that it is checked "on" in that menu. The panels can 
  also be turned off by clicked the "X" in the top right corner, in which case you
  will need to use the View menu to get them back.
 
By default, the three panels appear attached to the main Viewer Display Panel 
on the right side of the image. They may be dragged to new positions. Each of the
three panels can be attached to the left, top, right, or bottom of the main Viewer Display Panel or
they can be entirely undocked and left as free-floating panels.

NOTE: Depending on your window manager, windows without focus, including detached
panels and tools like the Spectral Profile Browser may sometimes display odd behavior. As a general
rule, giving the window focus by clicking on it will correct the issue. If you seem to "lose" a detached
panel (like an Animator Panel), then click in the main window to get it back.

NOTE: With all three panels turned on (and especially with several images loaded), the main display panel can sometimes shrink to
very small sizes as the panels grow. Try detaching the panels to get
the main display panel back to a useful size.

A restart of the viewer will display all docks in the state of a
previous viewer session, given that it was closed normally. In
addition, the viewer docking can be changed under ``Preferences''  In
the toolbar (Mac OS under the ``CASA Viewer'' tab on the toolbar,
Linux: ``Data''). Fig.\,\ref{fig:viewer_preferences} shows an
example. Each item can be changed and the input box will only allow
accepted input formats. A complete restart is required to apply the
changes. 


\begin{figure}[h!]
\begin{center}
\pngname{viewer-preferences}{3}
\caption{\label{fig:viewer_preferences}''Preferences'' dialog to
  manually change the docking and size of the viewer panel.}
\hrulefill
\end{center}
\end{figure}

\subsubsection{The Animator Panel}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_animatorpanel_41}{3}
\caption{\label{fig:viewer_animator} The animator panel, which allows one to scroll along the $z$ axis of a data cube (using the Channels tape deck) 
or cycle among open Images. The panel can be undocked from the main display panel.}
\hrulefill
\end{center}
\end{figure}

The Animator Panel allows you to scroll through the channels of a data
cube and to rotate among loaded images. The main features of the
panel are the two ``tape decks,'' one labeled "Channels" and one Labeled "Images"
(note that you will only see the Images tape deck when multiple images are loaded.  

The {\bf Channels} tape deck scrolls between planes of an individual image. By default, the
channel tape deck scrolls among frequency planes when R.A. and
Declination are the displayed axes (in this case, frequency is the "$z$ axis"). From 
outside to inside, the buttons cause the display to jump all the way to the beginning/end of the $z$ axis,
cause the viewer to step one plane forward or backward along the $z$ axis,
or start a movie. The limits on the $z$ axis can be set manually using the windows at the end
of the scroll bar. The scroll bar can also be dragged or the user can jump the display to a manually
entered plane by entering the plane into the text bock.

When you have multiple images loaded, the {\bf Images} tape deck cycles through 
which is image is being displayed. In the movie mode, it allows you continuously click
between images. Functionally, the image tape deck works similarly to the channels tape deck,
with the ability to step, jump, or continuously scroll through images.

NOTE: The check boxes next to the channel and images tabs enable or disable those panels. This doesn't
have much effect when the display has only a single panel, but with multiple panels (i.e., several 
maps at once in the main window) it changes the nature of the display. If the "Images" box is  
checked then interleaved maps from different cubes are display. Otherwise a series of maps from a 
single cube are shown.

\subsubsection{The Position Tracking Panel}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_positionpanel_41}{3}
\caption{\label{fig:viewer_position} The position tracking panel, which gives information about the open data cube
at the current location of the cursor. Freeze the position tracking panel using the SPACE bar.}
\hrulefill
\end{center}
\end{figure}

The {\bf Position Tracking} panel (below the images in Fig\,\ref{fig:viewer_start})
shows the intensity, position (e.g., RA and Dec), Stokes, frequency 
(or velocity), and pixel location for the point currently under the cursor.  A separate box
appears for each registered image or Measurement Set and you can see the
tracking information for each.  Tracking can be 'frozen' (and unfrozen again)
by hitting the space bar when the viewer's focus is on the main display area 
(to be sure that this is case first click on the main display area).

\subsubsection{The Region Manager Panel}

The {\bf Region Manager} panel becomes active when regions
are created. It has a large amount of functionality, from
display region statistics and histograms to creating position-velocity cuts.
We discuss these in \S\ref{section:display.image.region}. Like the 
Animator and Position Tracking panel, the Region Manager Panel can
be moved relative to the main viewer display panel or entirely undocked.

%%%%%%

\subsection{Saving and Restoring the Display Panel State}
\label{section:display.viewerGUI.save-restore}

You can save the display panel's current state --- meaning the 
panel settings and the data on display --- or load a saved panel
state from disk. To save the display panel state, select {\bf Save Panel State}
from the {\bf Display Panel} drop-down menu or click the 
"Save Display Panel State to File" icon on the main toolbar 
(an arrow pointing from a picture to a page, see Figure
\ref{fig:viewer_maintoolbar}). It is advisable but not required to retain the file's '.rstr' ("Restore")
extension.

You can restore the display panel to the saved state by loading the saved
state from the Data Manager Panel, by selecting {\bf Restore Panel State}
from the {\bf Display Panel} drop down menu, or by clicking the "Restore Display Panel State"
icon (just to the right of the "Save Display Panel State" icon).

It is possible to restore panel states viewing Measurement Sets or image and
panel states that have multiple layers, such as
contour plots over raster images. You can also save LEL displays.  You can also the save or 
restore the panel state with no data loaded, which is a
convenient way to restore preferred initial settings such as overall panel size.

{\em Data Locations:} The viewer is fairly forgiving regarding data location when restore a saved panel state.
It will find files located:
\begin{itemize}
  \item in the original location recorded in the restore file
  \item in the current working directory (where you started the viewer)
  \item in the restore file's directory
  \item in the original location relative to the restore file
\end{itemize}
This means that you can generally restore a saved panel state if you move that
file together with data files. The exception to this rule is that the process is less forgiving
if you save the display of an LEL expression. In this case the files must be in the locations 
specified in the original LEL expression.  If a data file is {\bf not} found, restore
will attempt to proceed but results may not be ideal. 

{\em Manually Editing Saved Display Panel States:} The saved "Restore" files are in ascii 
(xml) format, and manual edits are possible. However, these files are long and complex.  Use caution, and back 
up restore files before editing. If you make a mistake, the viewer may not  even recognize the file as a restore file.  
It is easier and safer to make changes on the display panel and then save the display panel state again.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Data Manager Panel --- Saving and Loading Data}
\label{section:display.dataManager}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_datamanager_41}{4}
\caption{\label{fig:viewer_load} The {\bf load} tab of the {\bf Data Manager} panel.
This appears if you open the {\tt viewer} without any {\tt infile} 
specified, if you use select {\bf Open} from the {\bf Data} drop down menu, or click the
Open (Folder) icon. You can access the {\bf save image} or {\bf save region} tabs
from this view or by selecting {\bf Save as...} from the {\bf Data} drop down menu.
The load tab shows all files in the current directory that can be loaded into the viewer 
--- images, MS, CASA region files, and Display Panel State files.}
\end{center}
\hrulefill
\end{figure}

The {\bf Data Manager Panel} is used to interactively save  and load
images, Measurement Sets, Display Panel States, and regions. An 
example of the loading tab in this panel is shown in Figure~\ref{fig:viewer_load}.  This
panel appears automatically if you open the viewer without specifying
an input file or it can be accessed through the {\tt Data:Open} menu or Open icon
of the {\bf Viewer Display Panel}.

\subsection{Loading Data}
\label{section:display.dataManager.load}

The {\bf load} tab of the {\bf Data Manager Panel} allows you to interactively
choose images or Measurement Sets to load into the viewer. The load tab
automatically shows you the available images, Measurement Sets, and
Display Panel States in the current directory that can be opened by the viewer.
When you highlight an image in this view, the tab shows a brief summary of
the image: pixel shape, extent of the image on the sky and in frequency/velocity, and 
restoring beam (if available).

Selecting a file will bring up information about that file in the panel on the right of the
Data Manager Panel provide options for how to display the data. Images can be displayed as: 

\begin{enumerate}
\item raster image 
\item contour map 
\item vector map
\item marker map  
\end{enumerate}

These options area each discussed in \S\,\ref{section:display.image}.

{\em LEL:} Instead of only loading an image from disk, you may ask the
viewer to evaluate a 'Lattice Expression Language' (LEL) expression (\S~\ref{section:analysis.pars.lattice}). This can
be entered in the box provided after you click the "LEL" box. The images used in the
LEL expression should have the same coordinates and extents. 

{\em Measurement Sets:} A Measurement Set can only be displayed as a raster. For 
measurement sets, the load tab offers options for data selection. This will reduce 
loading and processing times for visibility flagging.  

{\em Regridding Images on Load:} Optionally, you may regrid the velocity axis of an image 
on load to match the current coordinates grid in the Display Panel. In this case, the viewer
will interpolate (using the selected interpolation scheme) the cube on disk to share the 
same velocity gridding as the loaded coordinates. This can be used, e.g., to overlay contour
maps of different spectral lines or to make synchronized movies of multiple cubes. Note that
the regridding depends on the rest frequency in the image, which is used to calculate the
velocities used in regridding. 

\subsection{Registered vs. Open Datasets}
\label{section:display.viewerGUI.load.register}

When you load data as described above, it is first {\em opened}, and then
{\em registered} on all existing {\tt Display Panels}.  

An {\em open} dataset has been prepared in memory from disk.  All open datasets will 
have a tab in the {\tt Data Display Options} window, whether currently registered or not.  

When a data set is {\em registered} to a Display Panel its coordinates are aligned to
the master coordinate image in the panel and it is ready for drawing. If multiple Display Panels are open
then a data set may be registered on one {\tt Display Panel} and not on another. Only those
data sets registered on a particular Display Panel show up in its {\bf Position Tracking}
panel.

{\em Why Register More Than One Image?} It is useful to have more than one image registered on a
panel if you are displaying a contour image over a raster image
(\S~\ref{section:display.image.viewcontours}), to 'blink' between images
(see {\bf Animator} in \S~\ref{section:display.viewerGUI.displaypanel}), or to compare images
using the position tracking panel.

{\em Unregistering Images:} A data set can be registered or
unregistered using the {\bf Image Manager}
in the {\bf  Data} drop down menu or the {\bf Image Manager} icon
(third from left). It will open The Image Manager window and the
checkboxes can be used to register or unregister an image. 

{\em Closing vs. Unregistering:} You can close a data set that is no longer needed using the {\bf Close}
option in the {\bf Data} drop-down menu, the "Close" icon (fourth from
left), or right mouse button ``Close'' selection in the Image Manager (\S~\ref{section:display.viewerGUI.imanager}). 

If you close a dataset, you must reload it from disk (or recreate it if it's an LEL expression, regridded image, 
moment or something similar) to see it again.  If you unregister a dataset, it will draw immediately if you 
re-register it, with its options as you have 
previously set them.  In general, close unneeded datasets but unregister those that you intend to use again.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Image Manager}
\label{section:display.viewerGUI.imanager}

The {\tt Image Manager} is used to define the master coordinate image,
the sequence of images (e.g. for blinking), to register and unregister
images, close images, change between raster, contour, vector, and
marker displays, and to modify the properties of images. The panel
can be invoked from the ``Manage Images'' tool, the third icon from
the left (two overlapping squares).

An example is shown in Fig.\,\ref{fig:viewer_imanager}. In this case,
four images are loaded into the {\tt viewer}. The sequence of images
can be changed by dragging and dropping the images to new positions in
the stack. The letter to the left indicates whether the image is a
{\bf R}aster, {\bf C}ontour, {\bf V}ector, or {\bf M}marker
image. {\bf MC} marks the coordinate master, in this case the second
image. The checkboxes are to change the registration statuses. The
Coordinate Master image can be defined by a right mouse click, and
selection the corresponding option. The right mouse menu button also
offers options for quick changes between contour and raster images and
to close an image.

The {\bf Options} button will open a drop down box (as shown in
Fig.\,\ref{fig:viewer_imanager} for the first image), in which one
can again change between image type, change to a different rest
frequency, or open the ``Display Options'' panel for that specific
image with all the adjustment options explained in (\S
\ref{section:display.image.raster} or \S
\ref{section:display.image.contour}).


\begin{figure}[h!]
\begin{center}
\pngname{viewer_imanager}{4}
\caption{\label{fig:viewer_imanager} The Image Manager.}
\hrulefill
\end{center}
\end{figure}



\subsection{Saving Data or Regions}
\label{section:display.viewerGUI.save}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_saveas_41}{4}
\caption{\label{fig:viewer_save} The {\bf Save Data} panel
that appears when selecting the 'Save as...'  (Figure~\ref{fig:viewer_maintoolbar}).} 
\hrulefill
\end{center}
\end{figure}

The viewer can create new images by carrying out velocity regridding, evaluating an LEL
expression, or collapsing a data cube. You can save these images to disk using the 
Data Manager Panel. Select {\bf Save as} under the {\bf Data} drop-down menu or
click the {\bf Save as} (disk) icon to bring up the Data Manager Panel set to the save tabs.
This tab is shown in Figure~\ref{fig:viewer_save}. 

From the Save Image tab of the Data Manager Panel, you can export images from the
viewer to either a CASA image or FITS file on disk. Select the desired file name and click
"save." The Data Manager also allows you to save your current regions to a file, either in the CASA
or ds9 format. The left part lists all images that can be exported to disk.  To save an
image to a file, the use can either enter the new filename in the box
labeled 'output name:' followed by the save-button (alternatively the
'Enter'-key), or choose a file name from the right hand side.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Viewing Images}
\label{section:display.image}

There are several options for viewing an image.  These are seen
at the right of the {\bf Load Data - Viewer} panel 
described in \S~\ref{section:display.dataManager.load} and shown in 
Figure~\ref{fig:viewer_start} after selecting an image.  They are:
\begin{itemize}
   \item {\tt raster image} --- a greyscale or color image,
   \item {\tt contour map} --- contours of intensity as a line plot,
   \item {\tt vector map} --- vectors (as in polarization) as a line plot,
   \item {\tt marker map} --- a line plot with symbols to mark positions.
\end{itemize}

The {\tt raster image} is the default image display, and is what you
get if you invoke the Viewer with an image file and no other options.  
In this case, you will need to use the {\tt Open} menu to
bring up the {\bf Load Data} panel to choose a different display.

%
%\begin{figure}[h!]
%\begin{center}
%\pngname{viewer_load_image}{4}
%\caption{\label{fig:viewer_load_image} The {\bf Load Data - Viewer} panel
%as it appears if you select an image.  You can see all options
%are available to load the image as a {\tt raster image}, 
%{\tt contour map}, {\tt vector map}, or {\tt marker map}.
%In this example, clicking on the {\tt raster image} button would 
%bring up the displays shown in Figure~\ref{fig:viewer_start}.}
%\hrulefill
%\end{center}
%\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Viewing a Raster Map}
\label{section:display.image.raster}

A raster map of an image shows pixel intensities in a two-dimensional
cross-section of gridded data with colors selected a colormap according
to a scaling that can be specified by the user. 

% \begin{figure}[h!]
% \gname{viewer1}{3.5}
% \gname{viewer_loaddata}{3.5}
% \caption{\label{fig:viewer1} casaviewer: Illustration of a raster
%   image in the Viewer Display Panel(left) and the Load Data panel
%   (right).} 
% \hrulefill
% \end{figure}

Starting the {\tt casaviewer} 
with an image as a raster map will look
something like the example in Figure~\ref{fig:viewer_start}. 

Once loaded, the data display can be adjusted by the user 
through the {\bf Data Display Options} panel, which
appears when you choose the {\tt Data:Adjust} menu or use the
wrench icon from the {\bf Main Toolbar}.

The {\bf Data Display Options} window is shown in the right panel
of Figure~\ref{fig:viewer_start}.  It consists of a tab for each
image or MS loaded, under which are a cascading series of expandable
categories.  For an image, these are:
\begin{itemize}
   \item {\bf display axes}
   \item {\bf hidden axes}
   \item {\bf basic settings}
   \item {\bf position tracking}
   \item {\bf axis labels}
   \item {\bf axis label properties}
   \item {\bf beam ellipse}
   \item {\bf color wedge}
\end{itemize}
The {\bf basic settings} category is expanded by
default.  To expand a category to show its options, click on it with
the left mouse button.


%%%%%%
\subsubsection{Data Display Options --- display and hidden axes}
In this category the physical axes (i.e. Right Ascension, Declination,
Velocity, Stokes) to be displayed can be selected and assigned to the
x, y, and z axes of the display. The $z$ axis will be the axis scrolled across
by the channel bar in the Animator Panel.

If your image has a fourth axis (typically Stokes), then one of the axes
will need to be hidden and not used in viewing. Which axis is hidden 
can be controlled by a slider within the {\tt hidden axes} drop-down.

\subsubsection{Data Display Options --- basic settings}
\label{section:display.image.raster.adjust.basic}

This roll-up is open by default showing some commonly-used parameters
that alter the way the image is displayed. The most frequently used of these
change how the intensity value of a pixel maps to a color on 
the screen. An example of this part of the panel is shown in
Figure~\ref{fig:viewer_raster_basic}.

\begin{figure}[h!]
\begin{center}
\pngname{viewer_displaypanel_41}{6}
\caption{\label{fig:viewer_raster_basic} The {\tt basic settings}
category of the {\bf Data Display Options} panel and the interactive
tool for setting the mapping from intensity to color.}
\hrulefill
\end{center}
\end{figure}

The options available are:
\begin{itemize}

\item {\tt basic settings: aspect ratio}

This option controls the horizontal-vertical size ratio of data pixels
on screen.  {\tt fixed world} (the default) means that the aspect
ratio of the pixels is set according to the coordinate system of
the image (i.e., true to the projected sky). {\tt fixed lattice}
means that data pixels will always be square on the screen.  Selecting
{\tt flexible} allows the map to stretch independently in each
direction to fill as much of the display area as possible.

\item {\tt basic settings: pixel treatment}

This option controls the precise alignment of the edge of the current
'zoom window' with the data lattice.  {\tt edge} (the default) means
that whole data pixels are always drawn, even on the edges of the display.
For most purposes, {\tt edge} is recommended.  {\tt center} means that
data pixels on the edge of the display are drawn only from their centers
inwards. (Note that a data pixel's center is considered its 'definitive'
position, and corresponds to a whole number in 'data pixel' or 'lattice'
coordinates).

\item {\tt basic settings: resampling mode}

This setting controls how the data are resampled to the resolution of
the screen.  {\tt nearest} (the default) means that screen pixels are
colored according to the intensity of the nearest data point, so that
each data pixel is shown in a single color. {\tt bilinear} applies a
bilinear interpolation between data pixels to produce smoother looking images
when data pixels are large on the screen.  {\tt bicubic} applies an
even higher-order (and somewhat slower) interpolation.

\item {\tt basic settings: data range}

You can use the entry box provided to set the minimum and maximum data values
mapped to the available range of colors as a list {\tt [min, max]}.  
For very high dynamic range images,
you will probably want to enter a {\tt max} less than the data maximum 
in order to see detail in lower brightness-level pixels.

NOTE: By default you edit the scaling of a single image at once and
can click between the tabs at the top of the Data Display Options window
to manipulate different windows. By checking the Global Color Settings
box at the bottom of this window, you will manipulate the scaling for
all images at once. This can be very useful, for example, when attempting detailed
comparison multiple reductions of the same data.

\item {\tt basic settings: scaling power cycles}

This option allows logarithmic scaling of data values to colormap cells,
which can be very helpful in the case of very high dynamic range.

The color for a data value is determined as follows: 

\begin{enumerate}

\item The value is clipped to lie within the data range {\tt [min, max]}
specified above.
\item This clipped value is mapped to a new value depending on the selected
scaling power cycles in the following way:
\begin{itemize}
\item If the scaling power cycles is set to 0 (the default), the program considers
a linear range from {\tt [min, max]} and scales this directly onto the set of available colors.
\item For negative scaling values, the data value (after clipping on {\tt [min, max]} is scaled linearly to
lie between 0 and $10^p$ (where $p$ is the value chosen) and then program takes the logarithm
of this values,  yielding a value in the range 1 to $p$.  That value is scaled linearly to the set
of available colors. Thus the data is treated as if it had $p$ decades of range, with an equal 
number of colors assigned to each decade.
\item For positive scaling values, the data value (after clipping on {\tt [min, max]} is scaled linearly to
lie between 0 and $p$ (where $p$ is the value chosen) and 10 is raised to this power, 
yielding a value in the range 1 to $10^{p}$.  That value is scaled linearly to the set
of available colors.
\end{itemize}
\item  The color corresponding to a number in final range is determined
by the selected colormap and its 'fiddling' (shift/slope) and
brightness/contrast settings (see {\bf Mouse Toolbar}, above).  Adding
a {\bf color wedge} to your image can help clarify the effect of the
various color controls.

\end{enumerate}

See Figure~\ref{fig:scalingpower} for sample curves.

\begin{figure}[h]
\begin{center}
\pngname{viewer_scalingpower}{3.6}
\caption{\label{fig:scalingpower} Example curves for {\tt scaling power cycles}.}
\hrulefill
\end{center}
\end{figure}

In practice, you will often manipulate the data range bringing the max down in high dynamic range images,
raising the minimum to the near the noise level when using non-zero scaling cycles. It is also common to 
use negative power cycles when considering high dynamic range images --- this lets you bring out the
faint features around the bright peaks. 

\item {\tt basic settings: colormap}

You can select from a variety of colormaps here.  {\tt Hot Metal},
{\tt Rainbow} and {\tt Greyscale} colormaps are the ones most commonly used.

\end{itemize}

\subsubsection{Graphical Specification of the Intensity Scale}

A histogram icon next to the data range in the Data Display opens the Image Color Mapping window,
which allows visualization and graphical manipulation of the mapping of intensity to color. The window
at the left shows a histogram of the data with a gray range showing the data range. You can use
this window to select the data range graphically (with the mouse), manually (by typing into the empty windows),
or as a percentile of the data. On the right, you can select the scaling power cycles and see a visualization of
the transfer function mapping intensity ($x$-axis) to color ($y$-axis). 

The functionality here follows the other histogram tools, with the Display tab used to change the histogram plotting
parameters. It will often be useful to use a logarithmic scaling of the y-axis and filled histograms when manipulating
the color table.

%%%%%%
\subsubsection{Data Display Options --- other settings}
\label{section:display.image.raster.adjust.other}

Many of the other settings on the {\tt Data Options} panel for raster images
are self-explanatory such as those which affect {\tt beam ellipse} drawing
(only available if your image provides beam data), or the form of the
{\tt axis labeling} and {\tt position tracking} information.  You can also
give your image a {\tt color wedge}, a key to the current mapping from data
values to colors. 

\subsubsection{Viewer Canvas Manager --- Panels, Margins, and Backgrounds}
\label{section:display.viewerGUI.canvas.multi}

\begin{figure}[h!]
\begin{center}
%\gname{viewer_canvas}{3}
%\gname{viewer4}{3}
\pngname{viewer_multipanel_canvas}{2.5}
\pngname{viewer_multipanel_view}{3.5}
\caption{\label{fig:viewer_canvas} A multi-panel display
set up through the {\bf Viewer Canvas Manager}.} 
\hrulefill
\end{center}
\end{figure}

The display area can also be manipulated from the {\bf Viewer Canvas Manager} window. Use 
the wrench icon with a 'P' (or the 'Display Panel' menu) to show this window, which allows
you to manipulate the infrastructure of the main display panel. You can set:

\begin{itemize}
   \item Margins - specify the spacing for the left, right, top, and bottom margins
   \item Number of panels - specify the number of panels in x and y
         and the spacing between those panels.
   \item Background Color - white or black (more choices to come)
\end{itemize}

Figure~\ref{fig:viewer_canvas} illustrates a multi-panel display along
with the Viewer Canvas Manager settings which created it. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Viewing a Contour Map}
\label{section:display.image.contour}

Viewing a contour image is similar to viewing a raster map. A contour map
shows lines of equal data value for the
selected plane of gridded data (Figure~\ref{fig:viewer_con}).
Contour maps are particularly useful for overlaying on raster images so
that two different measurements of the same part of the sky can be shown
simultaneously (\S~\ref{section:display.image.viewcontours}).

Several {\tt basic settings} options control the contour levels used:

\begin{itemize}
\item The contours themselves are specified by a list in the box {\tt
  Relative Contour Levels}. These are defined relative to the two
  other parameters:
\item The {\tt Base Contour Level} sets the zero level for the
relative contour list corresponds to in units of intensity in the image.
\item The {\tt Unit Contour Level} sets what 1 in the relative contour list
corresponds to in units of intensity in the image.
\end{itemize}

Additionally, you have the option to manipulate the thickness and color of
the image and to have either positive or negative contours appear dashed.
 
\begin{figure}[h!]
\begin{center}
\pngname{viewer_n5921_con_1}{4.3}
\pngname{viewer_n5921_con_2}{2.1}
\caption{\label{fig:viewer_con} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} panel (right) after choosing
{\tt contour map} from the {\bf Load Data} panel.  The
image shown is for channel 11 of the NGC5921 cube, selected using
the {\bf Animator} tape deck, and zoomed in using the tool bar icon.
Note the different options in the open {\tt basic settings} category
of the {\bf Data Display Options} panel (as compared to {\tt raster image} in
Figure~\ref{fig:viewer_start}).}
\hrulefill
\end{center}
\end{figure}

For example, the following settings:

\small
\begin{verbatim}
   Relative Contour Levels = [0.2, 0.4, 0.6, 0.8]
   Base Contour Level = 0.0
   Unit Contour Level = <image max>
\end{verbatim}
\normalsize

would map the maximum of the image to 1 in the relative contour levels and the base contour level to
zero. So the contours will show 20\%, 40\%, 60\%, and 80\% of the peak.

Another approach is to set the unit contour to 1, so that the contours
are given in intensity units (usually Jy/beam). So this setup:

\small
\begin{verbatim}
   Relative Contour Levels = [0.010, 0.0.020, 0.040, 0.080, 0.160, 0.320]
   Base Contour Level = 0.0
   Unit Contour Level = 1.0
\end{verbatim}
\normalsize

would create contours starting at 10 mJy/beam and doubling every contour.

Another useful approach is to set contours in units of the rms noise level of the image,
which can be worked out from a signal free region. Then a setup like this:

\small
\begin{verbatim}
   Relative Contour Levels = [-3,3,5,10,15,20]
   Base Contour Level = 0.0
   Unit Contour Level = <image rms>
\end{verbatim}
\normalsize

Would indicate significance in the image. The first two contours 
show emission at $\pm$ 3-sigma and so on.

You can get the image rms using the {\tt imstat} task 
(\S~\ref{section:analysis.imstat}) or using the Viewer statistics
tool on a region of the image 
(\S~\ref{section:display.viewerGUI.displaypanel.region.stats}).

Not all images are of intensity, for example a
moment-1 image (\S~\ref{section:analysis.moments}) has units of
velocity.  In this case, absolute contours (like the last two examples) 
will work fine,  but by default the Viewer will
set fractional contours but referred to the min and max of the image:
\small
\begin{verbatim}
   Relative Contour Levels = [0.2, 0.4, 0.6, 0.8]
   Base Contour Level = <image min>
   Unit Contour Level = <image max>
\end{verbatim}
\normalsize
Here we have contours spaced evenly from min to max, and this is
what you get by default if you load a non-intensity image (like
the moment-1 image).  See Figure~\ref{fig:viewer_rascon} for an
example of this.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Overlay Contours on a Raster Map}
\label{section:display.image.viewcontours}

Contours of either a second data set or the same data set can be used
for comparison or to enhance visualization of the data. The Data Options
Panel will have multiple tabs (switch between them at the top of the window) 
that allow you to adjust each overlay individually.  

NOTE: {\tt axis labeling} is controlled
by the {\it first-registered} image overlay that has labeling turned on
(whether raster or contour), so make label adjustments within that tab.

To add a Contour overlay, open the {\bf Load Data} panel (Use the {\bf Data}
menu or click on the folder icon), select the data set and click on
{\tt contour map}. See Figure~\ref{fig:viewer_rascon} for an example using NGC5921.

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n5921_contour_moments_1}{4.3}
\pngname{viewer_n5921_contour_moments_2}{2.1}
\caption{\label{fig:viewer_rascon} The {\bf Viewer Display Panel}
(left) and {\bf Data Display Options} panel (right) after overlaying
a {\tt Contour Map} of velocity on a {\tt Raster Image} of intensity.  The
image shown is for the moments of the NGC5921 cube, zoomed in using the tool bar icon.
The tab for the contour plot is open in the {\bf Data Display Options} 
panel.} 
\hrulefill
\end{center}
\end{figure}



\subsection{Regions and the Region Manager}
\label{section:display.image.region}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionpanel_41}{4}
\caption{\label{fig:viewer_regionpanel} The Region Manager Panel, 
which becomes active once at least one region is created. Cycle through 
available regions using the slider bar at the bottom and use the various tabs
to adjust, analyze, load, and save regions.}
\hrulefill
\end{center}
\end{figure}

CASA regions are following the CASA 'crtf' standard as described in
\S~\ref{chapter:regionformat}. CASA regions can be used in all
applications, including {\tt clean} and image analysis tasks
(\S\,\ref{chapter:analysis}).

{\bf NOTE:} A leading 'ann' (short for annotation) to a
region definition indicates that it is for visual overlay purposes
only.

{\bf NOTE:} Whereas the region format is supported by all the data
processing tasks, some aspects of the {\tt viewer} implementation are still limited
to rectangles, ellipses, and some markers. Full support for all region types
is progressing with each CASA release. 

Once one or more regions are created, the Region Manager Panel becomes
active (see Figure \ref{fig:viewer_regionpanel}). Like the Position Tracking and 
Animator Panels, this can be docked or detached from the main viewer display.
It contains several tabs that can be used to adjust, analyze, and save or load regions.

{\bf NOTE:} Moving the mouse into a region will bring it into focus for the Spectral Profile or
Histogram tools.

\subsubsection{Region Creation, Selection, and Deletion}
\label{section:display.image.region.create}

Within the display area, you can draw regions or select positions using the mouse. 
Regions can be created with the buttons marked as 'R' in the mouse
tool bar (\S~\ref{section:display.viewerGUI.displaypanel},
\S~\ref{section:display.viewerGUI.displaypanel.region.pos}).  The viewer
currently supports creation of rectangles, ellipses, polygons, and the point. As
usual, a mouse button can be assigned to each button as indicated by
the small black square in each button (marking the left, middle, or
right mouse button \S~\ref{section:display.viewerGUI.displaypanel},
\S~\ref{section:display.viewerGUI.displaypanel.region.pos}). An example
is shown in Fig.\,\ref{fig:viewer_regionselected}.

Regions can be selected by SHIFT+click, de-selected by pressing
  SHIFT+click again. The bottom of the
  Region Manager Panel features a slider to switch between regions
in the image. Regions can be removed by hovering over and pressing
{\tt ESC} or by pressing the buttons to the right side of the slider
where the first button deletes all regions and the far right button
deletes the region that is currently displayed in the panel.

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionselected_41}{3}
\caption{\label{fig:viewer_regionselected} Selecting an image region (done with SHIFT+click). The region
can be resized by dragging the handles or deleted by hitting ESCAPE.}
\hrulefill
\end{center}
\end{figure}

Once regions are selected, they will feature little, skeletal squares
in the corners of their boundary boxes. Selected regions can be moved by dragging 
with the mouse button and manually resize by grabbing the corners as handles.
If more than one region is selected, all selected regions move together.

The {\tt Rectangle Region} drawing tool currently enables the full functionality of the various
Region Manager tabs (see below) as well as: 
\begin{itemize}
  \item Region statistics reporting for images via double clicking (also shown in the stats tab of the Region Manager),
  \item Defining a region to be averaged for the spectral profile tool (accessed via the {\tt Tools:Spectral Profile} drop down menu or "Open the Spectrum Profiler" icon),
  \item Flagging of Measurement Sets. Note that the {\tt Rectangle Region} tool's mouse button must also be double-clicked to confirm an MS flagging edit.
  \item Selecting Clean regions interactively (\S~\ref{section:im.clean.interactive})
\end{itemize}

The {\tt Polygon Region} and {\tt Ellipse Region} drawing have the same uses, except that polygon region
flagging of a Measurement Set is not supported.

\subsubsection{Region Positioning}
\label{section:display.viewerGUI.displaypanel.region.pos}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionpos_41}{4}
\caption{\label{fig:viewer_regionpos} The positioning tab in the Region Manager. Use it to
manually adjust the location, width, and display style of the selected region.}
\hrulefill
\end{center}
\end{figure}

With at least one region drawn, the region manager becomes active. Using the {\bf Properties}
tab, one can manually adjust the position, annotation, and display style of the region.
The {\bf frames} boxes set which planes of the image cube the region persists through (regions
can have a depth associated with them and will only appear in the frames listed in this range).
One can manually adjust the width and height and the center of the box in the chosen units.
The {\tt  'selection'} check box is an alternative way to the {\tt
  SHIFT+click} to select a region. The {\tt 'annotation'} checkbox
will place the {\tt 'ann'} string in front of the region ascii output
-- annotation regions are not be used for processing in, e.g. data
analysis tasks. In the {\bf line} and {\bf text} tabs, one can set the style with which the region is displayed,
the associated text, and the position and style of that text.

{\bf NOTE:} Updating the position of a region will update the spectral profile shown if the Spectral Profile tool
is open and the histogram if the Histogram tool is open. The views are linked. Dragging a region or adjusting
it manually with the Position tab is a good way to explore an image.

\subsubsection{Region Statistics}
\label{section:display.viewerGUI.displaypanel.region.stats}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionstats_41}{4}
\caption{\label{fig:viewer_regionstats} The statistics tab in the Region Manager.}
\hrulefill
\end{center}
\end{figure}

One of the most useful features of defining a region is the ability to extract statistics 
characterizing the intensity distribution inside the region. You can see these in the 
{\bf Statistics} tab of the of the Region Manager Panel (see Figure \ref{fig:viewer_regionstats}).
This displays statistics for the current region in the current plane of the current image.
When more than a single region is drawn, you can select them
one by one and the region panel will update the statistics to reflect the currently selected region. 
All values are updated on the fly when the region is dragged
across the image.


A similar functionality can be achieved by double clicking inside of a region. This will send
statistics information for this region in all registered images to the terminal, looking something like this:

\small
\begin{verbatim}
(IRC10216.36GHzcont.image) image
          Stokes         Velocity            Frame          Doppler        Frequency 
               I -2.99447e+11km/s             LSRK            RADIO      3.63499e+10 
  BrightnessUnit         BeamArea             Npts              Sum             Flux 
         Jy/beam          36.2521            27547     1.087686e-01     3.000336e-03 
            Mean              Rms          Std dev          Minimum          Maximum 
    3.948473e-06     3.723835e-04     3.723693e-04    -1.045624e-03     9.968892e-03 

\end{verbatim}
\normalsize

This is an easy way to copy and paste the statistical data to a program outside of CASA for
further use. 

Taking the RMS of the signal-free portion of an image or cube is a good way
to estimate the noise. Contrasting this number with the maximum of the image gives an estimate 
of the dynamic range of the image. The FluxDensity measurement gives
a way to use the viewer to do very basic photometry.

\subsubsection{Saving and Loading Regions}
\label{section:display.viewerGUI.displaypanel.region.saveload}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionsave_41}{4}
\caption{\label{fig:viewer_regionsave} The save/load tab in the Region Manager.}
\hrulefill
\end{center}
\end{figure}

The {\bf File} tab in the Region Manager allows one to save or load selected
regions, either individually or en masse. You can choose between CASA and 
ds9 region format. The
default is a CASA region file (saved with a *.crtf suffix, see
\S\,\ref{chapter:regionformat}). The DS9 format does not offer the full
flexibility and cannot capture stokes and spectral axes. DS9 regions
will only be usable as annotations in the viewer, they cannot be used
for data processing in other CASA tasks. When saving regions, one can choose
to save only the current region, all regions that were selected with
SHIFT+click, or all regions that are visible on the screen. 

{\bf NOTE:} The load functionality for this tab will only become available once at
least one region exists. To load a region when no regions exist, use the Data Manager
window (\S~\ref{section:display.dataManager}).

\subsubsection{The Region Fit}
\label{section:display.viewerGUI.displaypanel.region.fit}

{\bf NOTE:} This functionality is still under development. Its robustness and functionality will
be improved in future version of CASA.

The Viewer can attempt to fit a two dimensional Gaussian to the emission distribution inside the 
currently selected region. To attempt the fit, go to the {\bf Fit} tab of the Region Manager and click the
{\bf gaussfit} button in the bottom left of the panel. You can choose whether or not
to fit a sky level (e.g., to account for a finite background, either astronomical, sky, or instrumental).
After fitting the distribution, the {\bf Fit} panel shows the results of the fit, the center, major and minor axis,
and position angle of the Gaussian fit in pixels (I) and in world coordinates (W, RA and Dec). The 
detailed results of the fit will also appear in the terminal window, including a flag showing whether the
fit converged.

\subsubsection{The Region Histogram}
\label{section:display.viewerGUI.displaypanel.region.histogram}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_regionhist_41}{4}
\caption{\label{fig:viewer_regionhist} The histogram tab in the Region Manager. Right click to zoom.
Hit {\bf SHIFT + Right Click} to adjust the details of the histogram display.}
\hrulefill
\end{center}
\end{figure}

The Viewer will automatically derive a histogram of the pixel values inside the selected region.
This can be viewed using the {\bf Histogram} tab of the of the Region Manager Panel. This is 
a pared down version of the full Histogram Tool. You can manipulate the details of the histogram
plot by clicking:

\begin{enumerate}
\item Use the {\bf Right Click} to zoom - either to the full range, a selected percentile, or a range that you have graphically
selected by dragging the mouse (may still be under development).
\item Hit {\bf SHIFT + Right Click} to open the histogram options. This lets you toggle between a logarithmic and linear 
y-axis, choose between a line, outline, or filled histogram, and adjust the number of bins.
\end{enumerate}

The histogram will update as you change the plane of the cube or shift between region.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The Spectral Profile Tool}
\label{section:display.image.specprof}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specprof_41}{5.5}
\caption{\label{fig:viewer_specprof} The {\bf Spectral Profile} panel (right)
that appears when pressing the button {\bf Open the Spectrum Profiler} in the
{\bf Main Toolbar} and then use the tools to select a region in the image,
such as the rectangular region on the left panel. The Spectral Profile tool
shows the spectrum of the most recent region highlighted and updates to track movements 
of the region if moved by dragging with the mouse.} 
\hrulefill
\end{center}
\end{figure}

The {\bf Spectral Profile Tool} allows you examine the intensity as a function
frequency or velocity. To start a new Spectral Profile window, click the 
{\bf Spectral Profile} option from the {\bf Tools} drop-down menu or click the 
"Spectral Profile" (red line graph) icon from the Main Toolbar 
(see Fig.~\ref{fig:viewer_maintoolbar}). A new Spectral Profile window will appear. 

{\bf NOTE:} {\em Make Sure That You Use the Radio Version!} This section describes the 
"Radio" version of the profiler. To be sure that you have the radio version of the tool
selected (this may not be the default), click on the preferences icon 
( the gear fourth from the left) and make sure that the "Optical" option is not checked.

The Spectral Profile Tool consists of a toolbar (\S \ref{section:display.image.specprof.toolbar}),
a main display area (\S \ref{section:display.image.specprof.mainwindow}), and two associated tabs:
Spectral-Line Fitting (\S \ref{section:display.image.specprof.specfit}) and Line Overlays 
(\S \ref{section:display.image.specprof.lineoverlay}).

{\em Interaction With the Main Display Panel:} For the Spectral Profile tool to work, a region or point
must be specified in the main Viewer Display window. Use the mouse tools to specify a point, 
rectangle, ellipse, or polygon region. Alternatively, load a region file. The Spectral Profile tool will show 
a spectrum extracted from the region most recently highlight by the mouse in the main Viewer Display Panel.
The method of extraction can be specified by the user using a drop down menu below the spectrum in 
the Spectral Profile window; the method of extraction is mean by default).

The Spectral Profile tool can also feed back to the Main Display Panel. By holding CTRL and right clicking
in the spectrum, you will cause the Main Display Panel to jump to display the frequency channel corresponding
to the spectral (x) coordinate of the region clicked in the Spectral Profile tool. Holding CTRL and dragging out
a spectral range while holding the right mouse button will queue a movie scrolling through images across that spectral range. You can achieve the
same effect with the two-ended-arrow icon towards the right of the toolbar in the Spectral Profile window.

In both tabs, it will be useful to do select regions of frequency or velocity. You can do this with the parallel lines-and-arrow
icon (see below) or by holding shift, left clicking, and dragging out the range of interest. A shaded gray region should appear
indicating your selection.

\subsubsection{Spectral Profile Toolbar}
\label{section:display.image.specprof.toolbar}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specproftool_42}{4}
\caption{\label{fig:viewer_spectoolbar} The toolbar for the Spectral Profile tool allows the user to
save the spectrum, print or save the tool as an image, edit
preferences (general, tool, legend), spectral smoothing,
pan or zoom around the spectrum, select a range of interest, jump to a channel, or add a label.}
\hrulefill
\end{center}
\end{figure}

Figure \ref{fig:viewer_spectoolbar} shows the toolbar from the top portion of the {\bf Spectral Profile} 
window. From left to right, the icons allow the user to:

\begin{itemize}
\item (disk) export the current profile to a FITS or ASCII file
\item (printer) print the main window to a hard copy
\item (writing desk) save the panel as an image (PNG, JPG, PDF, etc.)
\item (gear) set plot preferences
\item (color wheel) set color preferences for the plot
\item (signpost) set legend preferences
\item (triangle) set the spectral smoothing method and kernel width
\item (arrows) pan the spectrum in the indicated direction
{\bf NOTE:} The arrow keys also allow one to pan using the keyboard.
\item (magnifying glass) zoom to the default zoom, in, and out
{\bf NOTE:} the +/- keys allow one to zoom with the keyboard
\item (parallel lines+arrows) drag out a range of interest in the spectrum, for use with fitting or line overlays.
\item (double-ended arrow) jump to a channel in the main viewer (single click) or define a range over which to play
a movie in the viewer (with a drag). {\bf NOTE:} You can also jump to a channel with {\bf CTRL+Right Click} and
queue a movie by holding {\bf CTRL} and dragging out a range while holding the right mouse button.
\item {notepad and pencil} Add or edit a label on the plot. Click this icon to enter a mode where you can
drag out a box to create a new annotation box or drag the corners of an existing one to resize it. You can edit 
the contents, color, and font of an existing annotation by right clicking on it and selecting "Edit Annotation"
in the main Spectral Profile window.
\end{itemize}

\begin{figure}[h!]
\begin{center}
\hrulefill \\
\pngname{viewer_prefs_1}{0.5}
\pngname{viewer_prefs_2}{2.0}
\pngname{viewer_prefs_3}{2.0}
\pngname{viewer_prefs_4}{1.0}
\caption{\label{fig:viewer_prefs} Preferences options in the Spectral Profile Tool. From the toolbar, one
can access dialogs to set overall viewer preferences, colors for
plotting, how the plot legend is displayed, and spectral smoothing
method and kernel width.}
\hrulefill
\end{center}
\end{figure}

Figure \ref{fig:viewer_prefs} shows the setting dialogs accessible from the toolbar. This {\bf Preferences} dialog opened by the gear icon allows the user to:

\begin{itemize}
\item Toggle automatic scaling the x- and y-ranges of the plot. 
\item Toggle the coordinate grid overlay in the background of the plot.
\item Toggle whether registered images other than the current one appear as overlays on the plot.
\item Toggle whether these profiles are plotted relative to the main profile {\em (in development)}.
\item Toggle the display of tooltips {\em (in development)}.
\item Toggle the plotting of a top axis.
\item Toggle between a histogram and simple line style for the plot.
\item Toggle between the radio and optical versions of the Spectral Profile tool {\em Note: We discuss only the radio version here; this mainly
impacts the Spectral Line Fitting and Collapse/Moments functionality.}.
\item Toggle the overplotting of a line showing the channel currently being displayed in the main Display Panel.
\end{itemize}

The {\bf Color Curve Preferences} dialog opened by the color wheel icon allows the user to:

\begin{itemize}
\item Select the color of the line marking the current channel shown in the main Display Panel.
\item Select the color used to overlay molecular lines from Splatalogue.
\item Select the color to plot the initial Gaussian estimate used in spectral line fitting.
\item Select the color used for the zoom rectangle.
\item Set a queue of colors used to plot the various data sets registered in the Display Panel.
\item Set a queue of colors to plot the set of Gaussian fits.
\item Set a queue of colors to plot the synthesized curve.
\end{itemize}

Two sets of preset colors, "Traditional" or "Alternative", are available and the user can define
their own custom color palette.

The legend options opened by the signpost icon allow the user to toggle the plotting of
a legend defining the curves shown in the main Spectral Profile window. Using a drop-down 
dialog, the legend can be placed in the top left corner of the plot, to the right of the plot, or below the plot. 
Toggling the color bar causes the color of the curve to be indicated either via a short bar or using
the color of the text itself. Double click the names of the files or curves to edit the text shown for that curve 
by hand.

The spectral smoothing option has two methods, {\it Boxcar} and {\it
  Hanning} with the selection of odd numbers for the smoothing kernel
width in channels.

\subsubsection{Main Spectral Profile Window}
\label{section:display.image.specprof.mainwindow}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specmain_41}{4}
\caption{\label{fig:viewer_specmain} The main panel for the {\bf Spectral Profile} tool. Buttons along
the bottom row allow the axes to be set. Arrow keys pan and dragging out an area with the mouse zooms.
Holding CTRL and right clicking in the spectrum will jump the main Viewer Display panel to display that
frequency channel.}
\hrulefill
\end{center}
\end{figure}

The main window shows the spectrum extracted from active region of the image in the 
main Display Panel. The spectra from the same region in any other registered images are also plotted 
if overlays are enabled.  Menus along the bottom of the image allow the user to select how the spectrum 
is displayed. From left to right:

\begin{itemize}
\item The units for the bottom spectral axis.
\item The units for the top spectral axis. {\bf NOTE:} dual axes are enabled only if a single image 
is registered and the top axis option is enabled. In general, dual axes are not well-defined for mixed data sets. The
exception is that open data cubes with matched frequency/spectral axes will allow dual axes.
\item The units for the left intensity or flux axis {\em Note: fraction of peak allows easy comparison of data
with disparate intensity scales.}.
\item The velocity reference frame used if a velocity axis is chosen for the top or bottom axis.
\item The method used to extract spectrum from the region --- a mean over all pixels in the region, a median,
sum, or a sum converting units to get a flux density over the region (Jy).
\item Toggle the calculation and overplotting of error bars calculated from scatter in the data ({\tt rmse} refers
to root mean square error).
\end{itemize}

In addition to these drop-down menus, the main Spectral Profile window allows the user to do the following using keyboard and mouse inputs: % (Figure \ref{fig:viewer_specmouse}):

\begin{itemize}
\item {\em jump the main Display Panel window to a specified channel (CTRL+Right click):} hold CTRL and right click in the spectrum. A marker will appear and the
main Viewer Display Panel will jump to display that channel.
\item {\em animate the main Display Panel in a movie across a frequency range (CTRL+Right click+drag):} hold CTRL, Right click, and drag. The main Viewer Display
panel will respond by showing a movie scrolling across the selected spectral channels.
\item {\em zoom the Spectral Profile (+/-, mouse drag)}: Use the +/- keys to zoom in the same
way as the toolbar buttons. Alternatively, press and dragging the left mouse button. A yellow box is drawn onto the panel. After releasing the mouse button,
the plot will zoom to the selected range.
\item {\em pan the Spectral Profile (arrows)}: Use the arrow keys to pan the plot.
\item {\em select a spectral range for analysis}: hold shift, left click, and drag. A gray area will be swept out in the display. This method can be used to select a range
for spectral line fitting or collapsing a data cube (in the Collapse/Moments window).
\end{itemize}

{\bf NOTE:} If the mouse input to the {\bf Spectral Profile} browser becomes confused hit the {\bf ESC} key several times and it will reset.

\subsubsection{Spectral-Line Fitting}
\label{section:display.image.specprof.specfit}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specfit_1}{4}
\caption{\label{fig:viewer_specproffit} The Spectral Line Fitting tab in the 
Spectral Profile Tool. The user can fit a combination of a polynomial and multiple Gaussian components,
specifying the range to be fit (gray region) manually or with a shift+click+drag. Initial estimates for each component
may be entered by hand or specified via an initial estimates GUI. The results are output to a dialog and text file with
the fit overplotted (here in blue) on the spectrum (with the possibility to save it to disk).}
\end{center}
\end{figure}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_specfit_2}{3}
\pngname{viewer_specfit_3}{3}
\caption{\label{fig:viewer_specproffit_2} The left panel shows the graphical specification of initial estimates for Gaussian fitting.
Slider bars specify the center, FWHM, and peak intensity for the initial estimate. The right panel shows the verbose output of
the fitting.}
\hrulefill
\end{center}
\end{figure}

{\bf NOTE:} Interactive spectral line fitting is still under development.

The {\bf Spectral-Line Fitting} tab, shown in Figures \ref{fig:viewer_specproffit} and \ref{fig:viewer_specproffit_2}, 
allows the user to interactively fit a combination of Gaussian and polynomial profiles to the data shown 
in the Spectral Line Profile tool. The tool includes a number of options, many of which remain under
development:

\begin{itemize}
\item A drag-down menu at the top of the panel allows the user to pick which data set to fit.
\item The spectral range to fit can be specified by either holding shift+left click+dragging out a region in the 
main spectral profile window or by typing it manually into the box at the top left of the fitting panel.
\item Optionally multiple fits can be carried out once, fitting each spectrum in the region in turn. To enable this,
check the ``MultiFit'' box. ({\em Under development.})
\item Optionally a polynomial of the specified order may be fit. To do so, check the "Polynomial" fit check box
and then specify the desired order. ({\em Under Development.}) 
\item The results may be saved to a text file. This text file should be specified {\em before} the fit is carried out. Click
"Save" and then use the dialog to specify the file name. {\em Note that 
the fit curve itself becomes a normal spectral profile data set and can be saved to disk using the toolbar (disk icon) after the 
fit.}
\item One or more Gaussians can be fit ({\em Results are presently most stable for one Gaussian.}). Specify the number of
Gaussians and then enter initial estimates for the peak, center, and FWHM in the table below. Any of these values can be fixed
for any of the Gaussians being fit. Initial estimates can also be manually specified by clicking {\bf Specify Estimates.} This brings up an additional 
GUI window (Figure \ref{fig:viewer_specproffit_2}), where slides can be used to specify initial estimates for each Gaussian to be fit.
\item For plotting purposes, one may wish to oversample the fit (i.e., plot a smooth Gaussian), you can do so by increasing the Fit Samples/Channel
to a high number to finely sample the fit when plotting.
\end{itemize}

{\bf NOTE:} Currently the tool works well for specifying a single Gaussian. Fitting multiple components can become unstable and
polynomial and multiple line-of-sight fitting are still under development. This is an area of active development and future releases 
will offer improved capabilities.

\subsubsection{Line Overlays}
\label{section:display.image.specprof.lineoverlay}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_lineoverlay_41}{4}
\caption{\label{fig:viewer_lineoverlay} Line Overlays in the Spectral Profile Tool. The {\bf Line Overlay} tab, shown at the bottom,
allows users to query the CASA copy of the Spaltalogue spectral line database. Enter the redshift of your source (right panel),
select and Astronomical Filter from the drop down menu, and use shift+click+drag to select a frequency range (or do so manually). 
The "Search" button will bring up the dialog seen at the left top part of the image, which can in turn be used to graph the candidate
lines in the main Spectral Profile window (here CO v=0).}
\hrulefill
\end{center}
\end{figure}

CASA ships with a local version of the Splatalogue spectral line database ({\tt www.splatalogue.net}) and this can be used to identify and overplot 
spectral transitions. This feature, shown in Figure \ref{fig:viewer_lineoverlay}, allows the user to search Splatalogue
over the range of interest. 

To overlay spectral lines:

\begin{enumerate}
\item Select the {\bf Line Overlays} tab in the Spectral Profiles tab.
\item If you know it, enter the redshift or velocity of your source in the "Doppler Shift" panel. Otherwise, the lines will be
overlaid assuming a redshift of 0.
\item Specify a minimum and maximum frequency range to search, either by typing a range or by holding 
shift and left click and dragging out a range in the spectrum (you will see a gray box appear). If you don't specify a range,
the tool will search over the frequency range of spectrum.
\item Optionally, you may select an astronomical filter from the list (for example, commonly used extragalactic lines or lines
often found in hot cores, see Splatalogue for more information). This is 
usually a good idea because it pares the potentially very large list of  candidate lines to a smaller set of reasonable candidates. 
\item Click "Search" and the Spectral Profile will search Splatalogue for a list of Spectral lines that that fit that Astronomical
Filter in that frequency range for that redshift. A dialog will pop up showing the list of candidate lines. 
\item Highlight one or more of these transitions and click "Graph Selected Lines." A set of vertical markers will 
appear in the main Spectral Profile window at the appropriate (redshifted) frequencies for the line.
\end{enumerate}

We emphasize that this feature remains under active development. Look for improved performance and an expanded feature set in the next release.

{\bf NOTE:} You will want to click "Clear Lines" between searches, especially if you update the redshift.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Brightness Profile Tool}
\label{section:display.image.bprofile}

The ``line'' tool can be used to display 1-dimensional brightness
profiles of images. The viewer accepts even more than one line
segments such as shown in Fig.\ref{fig:viewer_slicer}. The ``region''
dock will then display a preview of the slice in the ``Slice Cut'' tab
and the full ``1-D Slice Tool'' can be launched from there. This panel
allows one to select the interpolation method to connect the pixels,
and a number count for the sampled pixels in between
markers. ``Automatic'' will show all pixels. The x-axis of the display can
be either the distance or the absolute coordinates of the image,
e.g. RA and DEC. All segments are also listed at the bottom with their
start and end coordinates, the distance and the position angles of each
slice segment. The color tool can be used to give each segment a
separate color. 

\begin{figure}[h!]
\begin{center}
\pngname{viewer-slicer}{5}
\caption{\label{fig:viewer_slicer} 1-dimensional slice of an
  image. The 1D slicer tool shows the brightness distribution along
  line segments.} 
\hrulefill
\end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Collapse/Moments Tool}
\label{section:display.image.collapse}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_collapse_41}{4}
\caption{\label{fig:viewer_collapse} The {\bf Collapse/Moments} tool, accessed from
the Main Toolbar or the {\bf Tools} drop down menu. The mean spectrum from the region 
in the Main Display Panel appears in the top part of the tool. After selecting a range,
a moment to calculate, and optionally data to exclude click collapse to calculate a new image.}
\hrulefill
\end{center}
\end{figure}

The CASA Viewer can collapse a data cube into an image, for instance allowing to look at the emission 
integrated along the $z$ axis or the mean velocity of emission along the line of sight. You can
access this functionality via the Collapse/Moments tool (accessed via the Tools menu or the four arrow
icons), shown in Figure \ref{fig:viewer_collapse}.

The tool uses the same format as the Spectral Profile tool and will show the integrated spectrum of whatever region
or point is currently selected in the main Display Panel. To create a moment map:

\begin{enumerate}
\item Select a range over which to integrate either manually using the left part of the window, 
by adding an interval and typing in the values into the box or by holding {\bf SHIFT + Left Click}
and dragging out the range of interest.
\item Pick the set of algorithms that you will use to collapse the image along the $z$ axis. Clicking
toggles each moment method, and the collapse will create a new image for each selected moment.
For details on the individual collapse method, see the {\tt immoments} task for more details on
each moment.
\item The moment may optionally include or exclude pixels within a certain range (for example,
you might include only values with signal-to-noise three or greater when calculating the velocity dispersion). You
can enter the values to include or exclude manually in the {\tt Thresholding} window on the right or you can
open a histogram tool to specify this range graphically by clicking {\tt Specify Graphically} (before this can
work, you must click "Include" or "Exclude").
\item The results of the collapse be saved to a file, which consists of a string specifying the specific moment tacked onto
a root file name that you can specify using {\tt Select Root Output File.}
\item When you are satisfied with you chosen options, press {\tt Collapse.}
\end{enumerate}

{\bf NOTE:} Even if you don't save the results of the collapse to a file, you can still save the map later using the {\tt Save as...} entry in the 
Data pull down menu from the main Viewer Display Panel.

{\bf NOTE:} This area remains under active development and may still exhibit some stability issues in CASA 4.1.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Histogram Tool}
\label{section:display.image.histogram}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_histogram_41}{4}
\caption{\label{fig:viewer_histogram} The {\bf Histogram} tool, accessed from
the Main Toolbar or the {\bf Tools} drop down menu. Details of the display and
included pixels can be manipulated
via the menus along the top of the window. The right hand panel allows one to
attempt to fit a distribution to the histogram.}
\hrulefill
\end{center}
\end{figure}

CASA can calculate and visualize a histogram of pixel values inside a region of interest. To examine this histogram, select 
{\bf Histogram} from the {\bf Tools} drop-down menu or the Histogram icon (looks like a comb). This opens the full histogram
tool; more limited versions are accessible from the Region Manager Panel, the graphical color table manipulation tool,
and the Collapse/Moments tool. 

The resulting Histogram Tool should look something like Figure \ref{fig:viewer_histogram}. The menus along the top
(or the corresponding mouse clicks) allow one to:

\begin{itemize}
\item Zoom to the full range, a selected percentile, or a graphical range.
\item Change the display of the histogram to show a log axis, display as either a line plot, an outline, or a filled histogram. Change
the number of bins in the histogram, or clear the plot (to start over).
\item Configure what data are fed into the histogram. You can use this menu to tell the histogram to track the channel currently
selected in the main Viewer Display Panel (click the "Track Channel" box) or to integrate across some range of channels (defaulting
to the whole image). You can also switch the 2-D footprint used between the whole Image, the Selected Region, and All Regions.
\item Save (via the disk icon) an image of the histogram to a graphical file on disk.
\end{itemize}

The Histogram Tool also allows you to fit the distribution using either a Gaussian or a Poisson distribution, for example to estimate the
noise in the image (a Gaussian will be a good choice to describe the noise in most radio data cubes). You can specify initial 
estimates or let the program generate initial guesses. The fit is then overplotted on the histogram (colors can be adjusted by clicking
the color wheel icon in the toolbar) and details of the fit are printed to the text window below the fit button.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Two-D Fitting Tool}
\label{section:display.image.twodfit}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_twodfit_41}{4}
\caption{\label{fig:viewer_twodfit} The interface to the two dimensional fitting tool ({\tt Tools:Fit...} or the blue circles icon). 
The interface allows you to specify and automatically generate ({\bf Find Sources}) initial estimates, to specify the range of
pixel values to be included in the fit, and to specify the output (log file, residual image, and visualization). Click {\bf Fit} to 
start the fit.
}
\hrulefill
\end{center}
\end{figure}

{\bf NOTE:} This functionality is still under very active development. Not all features are functional at this point.

CASA can fit two dimensional Gaussians to an intensity distribution, and the Two-Dimensional Fitting tool in the Viewer exposes
this functionality interactively. This tool, accessed by the blue circles icon or the {\tt Tools:Fit...} menu item, has an interface
like that shown in Figure \ref{fig:viewer_twodfit}. The interface exposes several options:

\begin{enumerate}
\item You can select whether to fit only the selected region or the whole image plane and specify which channel of the cube you want to
operate on. {\bf NOTE:} The two dimensional fitter only operates on
a single channel at a time.
\item {\bf Initial Estimates:} The box in the top left corner allows the user to specify initial estimates by feeding in a file. The easiest way
to make an appropriate file is to edit an existing one. Even easier, you can use the {\bf Find Sources} button to automatically generate a
temporary file of initial estimates. {\bf NOTE:} This functionality is still under development. When it is working, you click on {\bf Find Sources}
\item {\bf Pixel Range:} You can choose to only include a certain range of pixel intensity values in the fit. For example, you might choose
to only fit Gaussians to pixels above a few times the measured noise level. You can use the {\bf Specify Graphically} button to bring up
an interactive histogram of the region (a reduced functionality version of the full Histogram Tool).
\item {\bf Output:} You can choose to save the output of the fit as a file to the specified directory and to subtract the fit from the image and
to subtract the fit from the original, creating a {\bf Residual Image} that gets stored as a CASA image and automatically loaded into the 
viewer. This gives a way to tell how well your fit describes the total emission.
\item {\bf Visualization:} You can toggle whether the fit is displayed on the viewer or not and change the color of the marker.
\end{enumerate}

Click {\bf Fit} to start the fit. If the fit does not converge, try improving your initial estimates and fitting again.

\subsection{Interactive Position-Velocity Diagram Creation}
\label{section:display.image.pvdiagram}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_pvcut_41}{4}
\caption{\label{fig:viewer_pvcut} Interactive creation of position-velocity cuts in the viewer. Use the P/V tool from the Mouse Toolbar to
define a cut, then use the pV tool from the Region Manager Panel to adjust the cut (including the width). Click Generate P/V to build
the position velocity cut and open it in a new Viewer Display Panel (from which it can be saved to disk).}
\hrulefill
\end{center}
\end{figure}

{\bf NOTE:} This functionality is still under very active development.

As of release 4.1.0, CASA supports the interactive creation of position velocity diagrams from data cubes. The route to create them
is illustrated in Figure \ref{fig:viewer_pvcut}:

\begin{enumerate}
\item Select the P/V cut tool from the Mouse Toolbar and use it to draw a line across a data cube along the axis you want to visualize.
\item Open the Region Manager Panel and go to the {\bf pV} tab.  Highlight the cut you just drew. You should see the end point coordinates
listed, along with information on the length and position angle of the cut. You can set the averaging width (in pixels) in a window at the bottom
of the tab.
\item When you are satisfied, hit {\bf Generate P/V}. This will create a new Main Viewer Display Panel showing the position velocity cut. The axes should
be Offset and velocity.
\end{enumerate}

The new image can be saved to disk with the {\tt Data:Save as...} option.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Viewing Measurement Sets}
\label{section:display.ms}

\begin{figure}[h!]
\begin{center}
\pngname{viewer_load_ms}{6}
\caption{\label{fig:viewer_load_ms} The {\bf Load Data - Viewer} panel
as it appears if you select an MS.  The only option available is
to load this as a {\tt Raster Image}.  In this example, clicking
on the {\tt Raster Image} button would bring up the displays shown
in Figure~\ref{fig:viewer_start_ms}.}
\hrulefill
\end{center}
\end{figure}

Visibility data can also be displayed and flagged directly from the
viewer. For Measurement Set files the only option for display is 'Raster'
(similar to AIPS task {\tt TVFLG}).  An example of MS display is
shown in Figure~\ref{fig:viewer_start_ms}; loading of an
MS is shown in Figure~\ref{fig:viewer_load_ms}.  

{\bf Warning:} {\em Only one MS should be registered at a time on a
Display Panel.} 
Only one MS can be shown in any case.  
You do not have to close other images/MSs, but you should at
least 'unregister' them from the Display Panel used for viewing the MS.
If you wish to see other images or MSs at the same time, create multiple
Display Panel windows.

% \begin{figure}[h]
% \gname{viewer_ms1}{3}
% \gname{viewer_ms2}{3}
% \caption{\label{fig:viewer_ms1} Display of visibility
%   data. The default axes are time vs. baseline.} 
% \hrulefill
% \end{figure}
 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Data Display Options Panel for Measurement Sets}
\label{section:display.ms.adjust}

The {\bf Data Display Options} panel provides adjustments for MSs
similar to those for images, and also includes flagging options.
As with images, this window appears when you choose the {\tt Data:Adjust}
menu or use the wrench icon from the {\bf Main Toolbar}. It is also shown
by default when an MS is loaded. The right panel
of Figure~\ref{fig:viewer_start_ms} shows a {\tt Data Options} window. 
It has a tab for each open MS, containing a set of categories.  The
options within each category can be either 'rolled up' or expanded by
clicking the category label.

For a Measurement Set, the categories are:
\begin{itemize}
   \item {\bf Advanced}
   \item {\bf MS and Visibility Selection}
   \item {\bf Display Axes}
   \item {\bf Flagging Options}
   \item {\bf Basic Settings}
   \item {\bf Axis Drawing and Labels}
   \item {\bf Color Wedge}
\end{itemize}

% (The envelope, please....  And the winner is...)

%%%%%%
\subsubsection{MS Options --- Basic Settings}
\label{section:display.ms.adjust.basic}

The {\bf Basic Settings} roll-up is expanded by
default.  It contains entries similar to
those for a raster image (\S~\ref{section:display.image.raster.adjust.basic}). 
Together with the brightness/contrast and colormap adjustment icons
on the {\tt Mouse Toolbar} of the Display Panel, they are especially
important for adjusting the color display of your MS.

The available Basic options are:

\begin{itemize}

\item {\tt Data minimum/maximum}

This has the same usage as for raster images.  
Lowering the data maximum will help brighten
weaker data values.

\item {\tt Scaling power cycles}

This has exactly the same usage as for raster images (see
\S~\ref{section:display.image.raster.adjust.basic}).  Again, lowering
this value often helps make weaker data visible.  If you want to view
several fields with very different amplitudes simultaneously, this is
typically one of the best adjustments to make early, together with the
{\tt Colormap fiddling} mouse tool, which is on the middle mouse button
by default.

\item {\tt Colormap}

{\tt Greyscale} or {\tt Hot Metal} colormaps are generally good choices
for MS data.

\end{itemize}



%%%%%%
\subsubsection{MS Options--- MS and Visibility Selections}
\label{section:display.ms.adjust.select}

\begin{itemize}

\item {\tt Visibility Type}

\item {\tt Visibility Component}

\item {\tt Moving Average Size}

\end{itemize}

This roll-up provides choice boxes for Visibility Type
(Observed, Corrected, Model, Residual) and Component (Amplitude,
Phase, Real, or Imaginary).  

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes1}{6}
\caption{\label{fig:viewer_axes_1} The MS for NGC4826 BIMA
observations has been loaded into the viewer.  We see the
first of the {\tt spw} in the Display Panel, and have opened
up {\tt MS and Visibility Selections} in the
{\bf Data Display Options} panel.  The display panel raster is
not full of visibilities because {\tt spw 0} is continuum and
was only observed for the first few scans.  This is a case where
the different spectral windows have different numbers of channels
also.}
\hrulefill
\end{center}
\end{figure}

Changes to Visibility Type or Component (changing from Phase to
Amplitude, for example) require the data to be retrieved again
from the disk into memory, which can be a lengthy process.  When a
large MS is first selected for viewing, the user must
trigger this retrieval manually by pressing the {\bf Apply} button
(located below all the options), after selecting the data to be
viewed (see {\tt Field IDs} and {\tt Spectral Windows}, below).

{\bf Tip:} Changing visibility type between 'Observed' and 'Corrected' can
also be used to assure that data and flags are reloaded from disk.  You
should do this if you're using another flagging tool such as autoflag
simultaneously, so that the viewer sees the other tool's new edits
and doesn't overwrite them with obsolete flags.  The {\bf Apply} button 
alone won't reload unless something within the viewer itself requires
it; in the future, a button will be provided to reload flags from the disk
unconditionally.  

You can also choose to view the difference from a running mean or the
local RMS deviation of either Phase or Amplitude.  There is a slider
for choosing the nominal number of time slots in the 'local neighborhood'
for these displays.

(Note: {\bf Insufficient Data} is shown in the tracking area during
these displays when there is no other unflagged data in the
local neighborhood to compare to the point in question.  The
moving time windows will not extend across changes in either field ID
or scan number boundaries, so you may see this message if your scan
numbers change with every time stamp.  An option will be added later
to ignore scan boundaries).

\begin{itemize}

\item {\tt Field IDs}

\item {\tt Spectral Windows}

\end{itemize}

You can retrieve and edit a selected portion of the MS data
by entering the desired Spectral Window and Field ID numbers into
these boxes.  {\bf Important:} Especially with large MSs, often the
first thing you'll want to do is to select {\bf spectral windows}
which all have the {\bf same number of channels} and the
{\bf same polarization setup}.  It also makes sense to edit only
a few fields at a time.   Doing this will also
greatly reduce data retrieval times and memory requirements.

You can separate the ID numbers with spaces or commas; you do not need to
enter enclosing brackets.  Changes to either entry box will cause
the selected MS data to be reloaded from disk.

If you select, say, spectral windows 7, 8, 23, and 24, the animator, slice
position sliders, and axis labeling will show 
these as 0, 1, 2, and 3 (the 'slice positions' or 'pixel coordinates' of the
chosen spectral windows).  Looking at the position tracking display is the best
way to avoid confusion in such cases.  It will show something like: 
{\tt Sp Win 23 (s 2)} when you are viewing spectral window 23 (plane 2
of the selected spectral windows).

Changes to MS selections will not be allowed until you have saved
(or discarded) any previous edits you have made (see {\tt Flagging Options 
-- Save Edits}, below).  A warning is printed on the console (not the logger).

Initially, all fields and spectral windows are selected.  To revert to
this 'unselected' state, choose 'Original' under the wrench
icons next to the entry boxes.

See Figure~\ref{fig:viewer_axes_1} for an example showing the use
of the {\tt MS and Visibility Selections} controls when 
viewing an MS.

%%%%%%
\subsubsection{MS Options --- Display Axes}
\label{section:display.ms.adjust.axes}

This roll-up is very similar to that for images: it allows the user to
choose which axes (from Time, Baseline, Polarization, Channel, and
Spectral Window) are on the display and the animator.  There are
also sliders here for choosing positions on the remaining axes.  (It's 
useful to note that the data {\it is} actually stored internally in
memory as an array with these five axes).

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes2}{6}
\caption{\label{fig:viewer_axes_2} 
The MS for NGC4826 from Figure~\ref{fig:viewer_axes_1}, now with the
{\tt Display Axes} open in the {\bf Data Display Options} panel.  By
default, {\tt channels} are on the {\bf Animation Axis} and thus in
the tapedeck, while {\tt spectral window} and {\tt polarization} are
on the {\tt Display Axes} sliders. } \hrulefill
\end{center}
\end{figure}

For MSs, changing the choice of axis on one control will automatically
swap axes, maintaining different axes on each control.  Changing axes
or slider/animator positions does not normally require pressing
{\bf Apply} --- the new slice is shown immediately.  
However, the display may be 
partially or completely grey in areas if the required data is not
currently in memory, either because no data has been loaded yet, or
because not all the selected data will fit into the allowed memory.
Press the {\bf Apply} button in this case to load the data
(see \S~\ref{section:display.ms.adjust.apply} and 
{\tt Max. Visibility Memory} at the end of 
\S~\ref{section:display.ms.adjust.adv}).

\begin{figure}[h!]
\begin{center}
\pngname{viewer_n4826_axes3}{6}
\caption{\label{fig:viewer_axes_3} The MS for NGC4826,
continuing from Figure~\ref{fig:viewer_axes_2}.  
We have now put {\tt spectral window} on the {\bf Animation Axis} 
and used the tapedeck to step to {\tt spw 2}, where we see the
data from the rest of the scans.  Now {\tt channels} is on a
{\tt Display Axes} slider, which has been dragged to show
{\tt Channel 33}.}
\hrulefill
\end{center}
\end{figure}

Within the {\tt Display Axes} rollup you may also select whether to order
the baseline axis by antenna1-antenna2 (the default) or by (unprojected)
baseline length.

See Figures~\ref{fig:viewer_axes_2}--\ref{fig:viewer_axes_3}
showing the use of the {\tt Display Axes} controls to change the axes on the
animation and sliders.

%%%%%%
\subsubsection{MS Options --- Flagging Options}
\label{section:display.ms.adjust.flagging}

These options allow you to edit (flag or unflag) MS data.
The Point Tool and Rectangle Region {\bf Mouse Tools}
(\S~\ref{section:display.viewerGUI.displaypanel.region.pos}) are used on
the display to select the area to edit.  When using the Rectangle Region
tool, double-click inside the selected rectangle to confirm the edit.

The options below determine how edits will be applied.

\begin{itemize}

\item {\tt Show Flagged Regions...}

You have the option to display flagged regions in the background
color (as in {\tt TVFLG}) or to highlight them with color.
In the former case, flagged regions look just like regions of no
data.  With the (default) color option, flags are shown in shades of blue:
darker blue for flags already saved to disk, lighter blue for
new flags not yet saved; regions with no data will be shown in black.

\item {\tt Flag or Unflag}

This setting determines whether selected regions will be flagged or
unflagged.  This does {\it not} affect previous
edits; it only determines the effect which later edits
will have.  Both flagging and unflagging edits can be accumulated
and then saved in one pass through the MS.

\item {\tt Flag/Unflag All...}

These flagging extent checkboxes allow you to extend your edit over any
of the five data axes.  For example, to flag {\it all} the data in a given
time range, you would check all the axes {\it except} Time, and then
select the desired time range with the {\tt Rectangle Region} mouse tool.
Such edits will extend along the corresponding axes over the entire selected
MS (whether loaded into memory or not) and optionally over unselected 
portions of the MS as well ({\tt Use Entire MS}, below).  Use care in
selecting edit extents to assure that you're editing all
the data you wish to edit.

\item {\tt Flag/Unflag Entire Antenna?}

This control can be used to extend subsequent edits to all baselines
which include the desired antenna[s].  For example, if you set this item
to 'Yes' and then click the point tool on a visibility position with
baseline 3-19, the edit would extend over baselines 0-3, 1-3, 2-3, 3-3,
3-4, ... 3-{\tt nAntennas-1}.  Note that the second antenna of the selection
(19) is irrelevant here -- you can click anywhere within the 'Antenna 3 block',
i.e., where the {\em first} antenna number is 3, to select all baselines
which include antenna 3.

This item controls the edit extent only along the baseline axis.  If you
wish to flag {\it all} the data for a given antenna, you must still check
the boxes to flag all Times, Channels, Polarizations and Spectral Windows.
There would be no point, however, in activating {\it both} this item and
the 'Flag All Baselines' checkbox.  You can flag an antenna in a limited
range of times, etc., by using the appropriate checkboxes and selecting
a rectangular region of visibilities with the mouse. 

{\bf Note:} You do not need to include the entire 'antenna block' in your
rectangle (and you may stray into the next antenna if you try). Anywhere
within the block will work.  To flag higher-numbered antennas, it often
helps to zoom in.

\item {\tt Undo Last Edit}

\item {\tt Undo All Edits}

The 'Undo' buttons do the expected thing: completely undo the effect of
the last edit (or all unsaved edits).  Please note,
however, that only unsaved edits can be undone here;
there is no ability to revert to the flagging state at the start of the
session once flags have been saved to disk (unless you have previously
saved a 'flag version'.  The flag version tool is not available through
the viewer directly).

\item {\tt Use Entire MS When Saving Edits?}

"Yes" means that saving the edits will flag/unflag over the entire MS,
{\it including} fields (and possibly spectral windows) which are not 
currently selected for viewing.  Specifically, data within time range(s)
you swept out with the mouse (even for unselected fields) will be edited.

In addition, if "Flag/Unflag All..." boxes were checked, such edits will
extend throughout the MS.  Note that only
unselected {\it times} (fields) can be edited {\it without} checking
extent boxes for the edits as well.  Unselected spectral windows, e.g.,
will {\it not} be edited unless the edit also has "Flag/Unflag All
Spectral Windows" checked.  

Warning: Beware of checking ``All Spectral Windows'' unless you have also 
checked "All Channels" or turned ``Entire MS'' off; channel edits appropriate 
to the selected spectral windows may not be appropriate to unselected
ones.  Set "Use Entire MS" to ``No'' if your edits need to apply only to the
portion of the MS you have selected for viewing.  {\it Edits can often be
saved significantly faster this way as well}.

Also note that checkboxes apply to individual edits, and must be checked
before making the edit with the mouse.  ``Use Entire MS'', on the other hand,
applies to all the edits saved at one time, and must be set as desired
before pressing "Save Edits".

\item {\tt Save Edits}

MS editing works like a text editor in that
you see all of your edits immediately, but nothing is committed to disk
until you press ``Save Edits''.  Feel free to experiment with all the other
controls; nothing but 'Save Edits' will alter your MS on disk. 
As mentioned previously, however, there is no way to undo your edits once
they are saved, except by manually entering the reverse edits (or restoring
a previously-saved 'flag version').

Also, {\it you must save} (or discard) {\it your edits before changing the 
MS selections}.  If edits are pending, the selection change will not be 
allowed, and a warning will appear on the console.  

If you close the MS in the viewer, {\it unsaved edits are simply discarded},
without prior warning.  It's important, therefore, to remember to save them
yourself.  You can distinguish unsaved flags (when using the 'Flags In Color'
option), because they are in a lighter shade of blue.

The program must make a pass through the MS on disk to save the edits.
This can take a little time; progress is shown in the console window.

\end{itemize}

%%%%%%
\subsubsection{MS Options---  Advanced}
\label{section:display.ms.adjust.adv}

These settings can help optimize your memory usage, especially for
large MSs.  A rule of thumb is that they can be increased until response
becomes sluggish, when they should be backed down again.

You can run the unix 'top' program and hit 'M' in it (to sort by memory
usage) in order to examine the effects of these settings.  Look at the
amount of RSS (main memory) and SWAP used by the X server and 'casaviewer'
processes.  If that sounds familiar and easy, then fiddling with these
settings is for you.  Otherwise, the default settings should provide
reasonable performance in most cases.

\begin{itemize}

\item {\tt Cache size}

The value of this option specifies the maximum
number of different views of the data to save so that they
can be redrawn quickly.  If you run an animation or scroll around
zoomed data, you will notice that the data displays noticeably faster
the second time through because of this feature.  Often, setting this
value to the number of animation frames is ideal  Note, however, that
on multi-panel displays, each panel counts as one cached image.

Large images naturally take more room than small ones.  The memory used
for these images will show up in the X server process.  If you need more
Visibility Memory (below) for a really large ms, it is usually better to
forgo caching a large number of views.

\item {\tt Max. Visibility Memory}

This option specifies how many megabytes of memory may be used to store
visibility data from the measurement set internally.  {\it Even if you do
not adjust this entry, it is useful to look at it to see how many megabytes
are required to store your entire (selected) MS in memory}.  If the slider
setting is above this, the whole selected MS will fit into the memory
buffer.  Otherwise, some data planes will be 'grayed out' (see 
{\tt Apply Button}, \S~\ref{section:display.ms.adjust.apply} below),
and the selected
data will have to be viewed one buffer at a time, which is somewhat less 
convenient. In most cases, this means you should {\bf select fewer fields
or spectral windows} -- see \S~\ref{section:display.ms.adjust.select}.
The 'casaviewer' process contains this buffer memory (it contains the entire
viewer, but the memory buffer can take most of the space).

\end{itemize}

%%%%%%
\subsubsection{MS Options --- Apply Button}
\label{section:display.ms.adjust.apply}

When viewing large MSs the display may be 
partially or completely grey in areas where the required data is not
currently in memory, either because no data has been loaded yet, or
because not all the selected data will fit into the allowed memory
(see {\tt Max. Visibility Memory} above).  When the
cursor is over such an area, the following message shows in the position
tracking area:
\small
\begin{verbatim}
   press 'Apply' on Adjust panel to load data
\end{verbatim}
\normalsize
Pressing the {\bf Apply} button (which lies below all the options) 
will reload the
memory buffer so that it includes the slice you are trying to view.

The message {\bf No Data} has a different meaning; in that
case, there simply {\it is} no data in the selected MS at the
indicated position.

For large measurement sets, loading visibility data into memory is the
most time-consuming step.  Progress feedback is provided in the
console window.  Again, careful selection of the data to be viewed can
greatly speed up retrieval.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Printing from the Viewer}
\label{section:display.print}

\begin{figure}[h!]
\begin{center}
%\pngname{viewer_printing}{6}
\pngname{viewer_jupiter_print}{6}
\caption{\label{fig:viewer_print} Printing the display to a hardcopy
of a file. From the {\bf Viewer Print Manager}, located in top right here and
accessed by the print icon or from the Data drop down menu, 
you can use the {\bf Save} button to save an image or {\bf Print}
directly to a printer. To achieve the best results, it is often helpful to
adjust the settings in the {\bf Data Display Options} and {\bf Viewer Canvas Manager},
shown at right.} 
\hrulefill
\end{center}
\end{figure}

You can select {\tt Data:Print} from the drop down menu or click 
the {\bf Print} icon to bring up the {\bf Viewer Print Manager}. From this 
panel, you can {\bf Print} the contents of Display Panel to a hardcopy
or {\bf Save} them as an image in a format selected from the drop-down
menu at the bottom left of the window. Note that the save feature will
overwrite the file in question without prompting.

The Viewer Print Manager allows you to adjust the DPI, orientation,
and page format (Output Media) for Postscript or PDF files and to
scale the image to a desired pixel size for other images.

To achieve the best output it is usually advisable to adjust the settings
in the {\bf Viewer Print Manager}, {\bf Data Display Options}, 
and {\bf Viewer Canvas Manager} . For PDF and Postscript output, turning
the DPI up all the way yields the best-looking results. For other images,
a white background often makes for better looking images than the 
default black. It is often necessary to increase the {\bf Line Width}
in the {\bf Axis Label Properties} (in the {\bf Data Display Options} panel)
to ensure that the labels will be visible when printed.  Increasing from the default
of {\tt 1.4} to a value around {\tt 2} often works well.

Figure~\ref{fig:viewer_print} shows an example of printing to a file while
adjusting the {\bf Data Display Options} and {\bf Viewer Canvas Manager} to
improve the appearance of the plot.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Image Viewer ({\tt imview})}
\label{section:display.imview}

The {\tt imview} task offers scriptable access to many viewer options.
This enables the production of customized plots without invoking the GUI 
and allows one to open the viewer to a carefully selected state.

{\tt imview} has the following inputs:

\small
\begin{verbatim}
#  imview :: View an image
raster              =         {}        #  (Optional)  Raster filename (string)
                                        #   or complete raster config
                                        #   dictionary. The allowed dictionary
                                        #   keys are file (string), scaling
                                        #   (numeric), range (2 element numeric
                                        #   vector), colormap (string), and
                                        #   colorwedge (bool).
contour             =         {}        #  (Optional)  Contour filename (string)
                                        #   or complete contour config
                                        #   dictionary. The allowed dictionary
                                        #   keys are file (string), levels
                                        #   (numeric vector), unit (float), and
                                        #   base (float).
zoom                =          1        #  (Optional)  zoom can specify
                                        #   intermental zoom (integer), zoom
                                        #   region read from a file (string) or
                                        #   dictionary specifying the zoom
                                        #   region. The dictionary can have two
                                        #   forms. It can be either a simple
                                        #   region specified with blc (2 element
                                        #   vector) and trc (2 element vector)
                                        #   [along with an optional coord key
                                        #   ("pixel" or "world"; pixel is the
                                        #   default) or a complete region
                                        #   rectangle e.g. loaded with
                                        #   "rg.fromfiletorecord( )". The
                                        #   dictionary can also contain a
                                        #   channel (integer) field which
                                        #   indicates which channel should be
                                        #   displayed.
axes                =         -1        #  (Optional)  this can either be a
                                        #   three element vector (string) where
                                        #   each element describes what should
                                        #   be found on each of the x, y, and z
                                        #   axes or a dictionary containing
                                        #   fields "x", "y" and "z" (string).
out                 =         ''        #  (Optional)  Output filename or
                                        #   complete output config dictionary.
                                        #   If a string is passed, the file
                                        #   extension is used to determine the
                                        #   output type (jpg, pdf, eps, ps, png,
                                        #   xbm, xpm, or ppm). If a dictionary
                                        #   is passed, it can contain the
                                        #   fields, file (string), scale
                                        #   (float), dpi (int), or orient
                                        #   (landscape or portrait). The scale
                                        #   field is used for the bitmap formats
                                        #   (i.e. not ps or pdf) and the dpi
                                        #   parameter is used for scalable
                                        #   formats (pdf or ps).
async               =      False        #  If true the taskname must be started
                                        #   using imview(...)



\end{verbatim}
\normalsize

The {\tt raster} and {\tt contour} parameters specify which images to load
and how these images should be displayed. These parameters take 
python dictionaries as inputs. The fields in these dictionaries specify how
the image will be displayed.

An example call to {\tt imview} looks like this:

\small
\begin{verbatim}
imview(raster={'file': 'ngc5921.clean.image',
                       'range': [-0.01,0.03],
                       'colormap': 'Hot Metal 2',
                       'scaling': -1},
               contour={'file': 'ngc5921.clean.image'},
               axes={'x':'Declination'} ,
               zoom={'channel': 7, 'blc': [75,75], 'trc': [175,175],
                     'coord': 'pixel'},
               out='myout.png')
\end{verbatim}
\normalsize

The argument to {\tt raster} is enclosed in the curly braces \{ \} . Within these
braces are a number of "key":"value" pairs. Each sets an option in the viewer,
with the GUI parameter to set defined by the "key" and the value to set it to
defined by "value." In the example above, 'file':'ngc5921.clean.image' 
sets the file name of the raster image, 'range': [-0.01,0.03] sets the range of
pixel values used for the scaling.

{\tt contour} works similar to 'raster' but can accept multiple dictionaries in order to produce
multiple contour overlays on a single image. To specify multiple contour overlays, simply 
pass multiple dictionaries (comma delimited) in to the contour argument:

\small
\begin{verbatim}
 contour={'file': 'file1.image', 'levels': [1,2,3] },
         {'file': 'file2.image', 'levels': [0.006, 0.008, 0.010] }
\end{verbatim}
\normalsize

{\tt zoom} specifies the part of the image to be shown.

{\tt axes} defines what axes are shown. By default, the viewer 
will show 'x':'Right Ascension', 'y':'Declination' but one may also
view position-frequency images. 

{\tt out} defines the filename of the output, with the extension setting the file type. 

Currently, the following parameters are supported with additional functionality
planned for future releases:

\small
\begin{verbatim}
raster  -- (string) image file to open
           (dict)   file (string)     => image file to open
                    scaling (float)   => scaling power cycles
                    range (float*2)   => data range
                    colormap (string) => name of colormap
                    colorwedge (bool) => show color wedge?
contour -- (string) file to load as a contour
           (dict)   file (string)     => file to load
                    levels (float*N)  => relative levels
                    base (numeric)    => zero in relative levels
                    unit (numeric)    => one in the relative levels
zoom    -- (int)    integral zoom level
           (string) region file to load as the zoom region
           (dict)   blc (numeric*2)   => bottom left corner
                    trc (numeric*2)   => top right corner
                    coord (string)    => pixel or world
                    channel (int)     => channel to display
           (dict)   <region record>   => record loaded
                                         e.g. rg.fromfiletorecord( )
axes    -- (string*3) dimension to display on the x, y, and z axes
           (dict)     x               => dimension for x-axes
                      y               => dimension for y-axes
                      z               => dimension for z-axes
out     -- (string) file with a supported extension
                    [jpg, pdf, eps, ps, png, xbm, xpm, ppm]
            (dict)    file (string)   => filename
                      format (string) => valid ext (filename ext overrides)
                      scale (numeric) => scale for non-eps, non-ps output
                      dpi (numeric)   => dpi for eps or ps output
                      orient (string) => portrait or landscape
\end{verbatim}
\normalsize

Examples are also found in {\tt help imview}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Measurement Viewer ({\tt msview})}
\label{section:display.msview}

The Measurement Viewer {\tt msview} is mostly a clone of the {\tt
  viewer} at this stage. A difference is that {\tt msview} allows the
user to select data before it is loaded into the GUI and displayed. A
screenshot is shown in Fig.\,\ref{fig:msview-selection} and selection
parameters are {\tt field, spectral window, time range, uv range,
  antenna, corr, scan, array, ms selection expression} in the usual
CASA selection syntax (see Sect.\,\ref{section:io.selection}). 


\begin{figure}[h!]
\begin{center}
%\gname{casa_inpclean1}{6}
%\pngname{clean_inputs_1}{6}
\pngname{msview-selection}{6}
\caption{\label{fig:msview-selection} Data selection in {\tt msview}.}
\hrulefill
\end{center}
\end{figure}
 